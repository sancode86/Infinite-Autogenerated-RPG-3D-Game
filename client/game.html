<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css"
    />
    <title>Infinite RPG</title>
  </head>
  <script
    src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
    crossorigin="anonymous"
  ></script>
  <body>
    <div class="statsDiv" id="statsDiv"></div>
    <div class="morirCartel" id="morirCartel" style="display: none">
      <h1 class="glow">HAS MUERTO</h1>
    </div>
    <div class="levelup" id="levelup" style="display: none">
      <br />
      <p class="glow2">LEVEL UP</p>
    </div>

    <div class="sinEspacio" id="noHayEspacio" style="display: none">
      <p>No tienes mas espacio.</p>
    </div>
    <div class="infoEnemigo" id="infoEnemigo" style="display: none">
      <br />
      <p>Enemigo</p>
      <progress id="infoEnemigoBarra" class="barraSalud" value="100" max="100">
        100%
      </progress>
    </div>
    <div class="sidebar">
      <div class="hora" id="clock"></div>
      <a href="#" onclick="preferencesOpen()"
        ><i class="fa-solid fa-briefcase"></i>
      </a>
      <a href="#" onclick="activarBuffer()"
        ><i id="buffer" class="fa-solid fa-sun"></i>
      </a>
      <p id="saludBarra" class="navItem">ü§ç 100</p>
    </div>
    <div
      data-tilt
      data-tilt-max-glare="0.1"
      data-tilt-glare="true"
      data-tilt-perspective="1000"
      data-tilt-scale="1"
      data-tilt-speed="1"
      id="mercado"
      class="mercado animate__animated animate__fadeIn center"
      style="display: none"
    >
      <h1 class="mercadoTitulo">Mercado</h1>
      <p style="display: none; color: white" id="noPuedesComprar">
        No tienes suficientes monedas o espacio.
      </p>
      <p id="dineroMercado" class="dineroMercado">üí∞ 0</p>
      <div class="contenedorMercado" id="contenedorMercado"></div>
      <button class="botonSave2" onclick="cerrarMercado()">Cerrar</button>
    </div>
    <div
      data-tilt
      data-tilt-max-glare="0.1"
      data-tilt-glare="true"
      data-tilt-perspective="1000"
      data-tilt-scale="1"
      data-tilt-speed="1"
      id="optionsMenu"
      class="optionsMenu animate__animated animate__fadeIn center"
      style="display: none"
    >
      <div
        class="vistaPreviaArmadura dropdown-content"
        id="vistaPreviaArmadura"
        style="display: none"
      ></div>
      <div
        class="vistaPreviaArma dropdown-content"
        id="vistaPreviaArma"
        style="display: none"
      ></div>
      <div
        class="vistaPreviaCollar dropdown-content"
        id="vistaPreviaCollar"
        style="display: none"
      ></div>
      <div
        class="vistaPreviaAnillo dropdown-content"
        id="vistaPreviaAnillo"
        style="display: none"
      ></div>

      <table class="pj">
        <tr>
          <th class="imagenPj">
            <button
              id="contenedorArmadura"
              class="contenedorArmadura"
              onclick="sacarItemPuesto('armadura');"
              onmouseover="verItemPuesto('armadura');"
              onmouseleave="verItemPuestoClose()"
            ></button>
            <button
              id="contenedorArma"
              class="contenedorArma"
              onclick="sacarItemPuesto('arma');"
              onmouseover="verItemPuesto('arma');"
              onmouseleave="verItemPuestoClose()"
            ></button>
            <button
              id="contenedorAnillo"
              class="contenedorAnillo"
              onclick="sacarItemPuesto('anillo');"
              onmouseover="verItemPuesto('anillo');"
              onmouseleave="verItemPuestoClose()"
            ></button>
            <button
              id="contenedorCollar"
              class="contenedorCollar"
              onclick="sacarItemPuesto('collar');"
              onmouseover="verItemPuesto('collar');"
              onmouseleave="verItemPuestoClose()"
            ></button>
          </th>
          <th id="statsPj" class="statsPj">
            <h1>STATS</h1>
            <div class="textoStatsPj">
              <table class="tabla">
                <tr>
                  <th>
                    <p>üîÄ Nivel:</p>
                    <p>ü¶æ Fuerza:</p>
                    <p>üõ°Ô∏è Defensa:</p>
                    <p>‚ù§Ô∏è Salud:</p>
                    <p>üìñ Exp:</p>
                    <p>üí∞ Dinero:</p>
                    <p>‚öñÔ∏è Peso:</p>
                  </th>

                  <th>
                    <p id="nivelId">1</p>
                    <p id="fuerzaId">10</p>
                    <p id="defensaId">5</p>
                    <p id="saludId">100</p>
                    <p id="experienciaId">0/100</p>
                    <p id="monedasId">0</p>
                    <p id="pesoId">0/200</p>
                  </th>
                </tr>
              </table>
            </div>
          </th>
        </tr>
      </table>

      <div id="inventarioARellenar"></div>
    </div>
    <script src="utils/tilt.js"></script>
  </body>
</html>
<script src="js/menuDragInGame.js"></script>
<script src="js/optionsMenu.js"></script>
<script>
  $(".js-tilt").tilt({
    glare: true,
    maxGlare: 0.1,
  });
</script>
<script type="module">
  import * as THREE from "https://cdn.skypack.dev/three@0.136.0/build/three.module.js";
  import { OrbitControls } from "https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js";
  import { GLTFLoader } from "https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/GLTFLoader.js";
  import { OBJLoader } from "https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/OBJLoader.js";

  var jugadorStats = {
    fuerza: 10,
    defensa: 5,
    salud: 100,
    nivel: 1,
    experiencia: 0,
    monedas: 0,
    peso: 0,
  };
  var jugadorStatsConEquipo = {
    fuerza: 0,
    defensa: 0,
  };
  var jugadorEquipoEnUso = {
    armadura: "",
    arma: "",
    collar: "",
    anillo: "",
  };
  var lucesSoloEnPrimerCuarto = 0;
  var arrayPuertas = [];
  var coolDownFlag = 0;
  var segsCoolDown = 0;
  var particulasBuff = [];
  var inventario = [];
  var inventarioMercado = [];
  var arrayParedes = [];
  var bufferActivado = false;
  var sonidoMorirFlag = 0;
  var segs = 0;
  var jugadorAtacando = 0;
  var morir = 0;
  var draggable;
  var fg = 1;
  var jugador;
  var characterControls;
  var arrayLuces = [];
  var arrayFuegos = [];
  var sonidoCorrerFlag = 0;
  var sonidoAtacarFlag = 0;
  var arraySolidos = [];
  var arrayEnemigos = [];
  var gameTime = 1111104000000;
  var stats = new Stats();
  var statsDiv = document.getElementById("statsDiv");
  //VARIA

  // var tama√±oCuarto = 50;
  // var spawnArea = tama√±oCuarto / 2;
  var cantidadCajas = 0;

  var posicionActualJugador = new THREE.Vector3(0, 0, 0);

  window.verItemPuestoClose = verItemPuestoClose;
  window.comprar = comprar;
  window.cerrarMercado = cerrarMercado;
  window.verItemPuesto = verItemPuesto;
  window.sacarItemPuesto = sacarItemPuesto;
  window.inventario = inventario;
  window.jugadorEquipoEnUso = jugadorEquipoEnUso;
  window.jugadorStats = jugadorStats;
  window.activarBuffer = activarBuffer;
  stats.showPanel(0);
  statsDiv.appendChild(stats.domElement);
  import { CharacterControls } from "./utils/characterControls.js";
  import {
    lootArrayArmadura,
    lootArrayArma,
    lootArrayCollar,
    lootArrayAnillo,
  } from "./utils/loot.js";
  // SCENE
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xa8def0);
  // CAMARA
  const camera = new THREE.PerspectiveCamera(
    45,
    window.innerWidth / window.innerHeight,
    0.1,
    10000
  );
  camera.position.y = 15;
  camera.position.z = 15;
  camera.position.x = 0;
  // RENDERER
  const renderer = new THREE.WebGLRenderer({ antialias: false });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.shadowMap.enabled = false;
  // CONTROLS
  const orbitControls = new OrbitControls(camera, renderer.domElement);
  orbitControls.enableDamping = true;
  orbitControls.minDistance = 2;
  orbitControls.maxDistance = 100;
  orbitControls.enablePan = false;
  orbitControls.maxPolarAngle = Math.PI / 2 - 0.05;
  orbitControls.update();
  new GLTFLoader().load("models/Warrior.gltf", function (gltf) {
    musicaPlay();
    jugador = gltf.scene;
    jugador.traverse(function (object) {
      if (object.isMesh) object.castShadow = true;
    });
    jugador.userData.name = "jugador";
    jugador.position.set(0, 0, 0);
    jugador.scale.set(0.8, 0.8, 0.8);
    var jugadorGeometry = new THREE.BoxGeometry(1, 3, 1);
    jugador.geometry = jugadorGeometry;
    scene.add(jugador);
    const gltfAnimations = gltf.animations;
    const mixer = new THREE.AnimationMixer(jugador);
    const animationsMap = new Map();
    gltfAnimations
      .filter((a) => a.name != "TPose")
      .forEach((a) => {
        animationsMap.set(a.name, mixer.clipAction(a));
      });
    characterControls = new CharacterControls(
      jugador,
      mixer,
      animationsMap,
      orbitControls,
      camera,
      "Idle"
    );
  });
  //raycaster
  const raycaster = new THREE.Raycaster();
  const clicMouse = new THREE.Vector2();
  const moveMouse = new THREE.Vector2();
  window.addEventListener("click", (event) => {
    camera.updateProjectionMatrix();
    if (draggable) {
      document.body.style.cursor = "default";
      draggable = null;
      return;
    }
    clicMouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    clicMouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(clicMouse, camera);
    const found = raycaster.intersectObjects(scene.children);
    if (found.length > 0 && found[0].object.userData.draggable) {
      draggable = found[0].object;
      document.body.style.cursor = "grab";
    }
    var objFound = found[0].object;
    if (found.length > 0 && objFound.userData.name != undefined) {
    }
    if (
      found.length > 0 &&
      objFound.userData.tipo == "cofre" &&
      objFound.userData.estado == "cerrado"
    ) {
      var posX = objFound.position.x;
      var posZ = objFound.position.z;
      var selectedObject = scene.getObjectByName(objFound.userData.name);
      abrirCofre(selectedObject);
    }
    if (found.length > 0 && objFound.parent.userData.tipo == "recurso") {
      varSiPuedeLevantarLoot(objFound);
    }

    if (
      found.length > 0 &&
      objFound.parent?.parent?.userData?.nombre == "Enemigo"
    ) {
      mostrarVidaEnemigo(objFound.parent.parent.userData.salud);
    }
    if (
      found.length > 0 &&
      objFound.parent?.parent?.userData?.name == "Mercado"
    ) {
      abrirMercado();
    }
  });
  window.addEventListener("mousemove", (event) => {
    moveMouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    moveMouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(moveMouse, camera);
    const found = raycaster.intersectObjects(scene.children);
    if (draggable == null) {
      document.body.style.cursor = "default";
    }
    if (found[0].object.userData.draggable && draggable == null) {
      document.body.style.cursor = "pointer";
    }
  });
  function draggObj() {
    if (draggable != null) {
      raycaster.setFromCamera(moveMouse, camera);
      const found = raycaster.intersectObjects(scene.children);
      if (found.length > 0) {
        for (let o of found) {
          if (
            !o.object.userData.ground &&
            o.object.userData.pared != true &&
            o.object.userData.nombre != "universo"
          ) {
            if (draggable.userData.tipo != "piedra") {
              draggable.position.x = o.point.x;
              draggable.position.z = o.point.z;
            }
            if (draggable.userData.tipo == "piedra") {
              draggable.parent.position.x = o.point.x;
              draggable.parent.position.z = o.point.z;
            }
          }
        }
      }
    }
  }
  function checkearSiSeTocan(a, d) {
    let b1 = a.position.y - a.geometry.parameters.height / 2;
    let t1 = a.position.y + a.geometry.parameters.height / 2;
    let r1 = a.position.x + a.geometry.parameters.width / 2;
    let l1 = a.position.x - a.geometry.parameters.width / 2;
    let f1 = a.position.z - a.geometry.parameters.depth / 2;
    let B1 = a.position.z + a.geometry.parameters.depth / 2;
    let b2 = d.position.y - d.geometry.parameters.height / 2;
    let t2 = d.position.y + d.geometry.parameters.height / 2;
    let r2 = d.position.x + d.geometry.parameters.width / 2;
    let l2 = d.position.x - d.geometry.parameters.width / 2;
    let f2 = d.position.z - d.geometry.parameters.depth / 2;
    let B2 = d.position.z + d.geometry.parameters.depth / 2;
    if (t1 < b2 || r1 < l2 || b1 > t2 || l1 > r2 || f1 > B2 || B1 < f2) {
      return false;
    }
    return true;
  }
  function checkearSiSeTocaJugador(a, d) {
    let r1 = a.position.x + a.geometry.parameters.width / 2;
    let l1 = a.position.x - a.geometry.parameters.width / 2;
    let f1 = a.position.z - a.geometry.parameters.depth / 2;
    let B1 = a.position.z + a.geometry.parameters.depth / 2;
    let r2 = d.position.x + d.geometry.parameters.width / 2;
    let l2 = d.position.x - d.geometry.parameters.width / 2;
    let f2 = d.position.z - d.geometry.parameters.depth / 2;
    let B2 = d.position.z + d.geometry.parameters.depth / 2;
    if (r1 < l2 || l1 > r2 || f1 > B2 || B1 < f2) {
      return false;
    } else {
      if (a.position.x > d.position.x) {
        return "derecha";
      }
      if (a.position.z < d.position.z) {
        return "arriba";
      }
      if (a.position.z > d.position.z) {
        return "abajo";
      }
      if (a.position.x < d.position.x) {
        return "izquierda";
      }
    }
  }

  //CREACION PRINCIPAL
  crearHabitacion(50, 0, 0);

  function crearHabitacion(tama√±o, posicionX, posicionZ) {
    var tama√±oCuarto = tama√±o;
    var spawnArea = tama√±oCuarto / 2;
    buffer();
    crearSuelo(tama√±oCuarto, posicionX, posicionZ);
    crearLuces(tama√±oCuarto, posicionX, posicionZ);
    // crearCajas();
    crearParedes(tama√±oCuarto, posicionX, posicionZ);
    cargarInventario();
    crearCofres(spawnArea, posicionX, posicionZ);
    crearObjetosRandom(spawnArea, posicionX, posicionZ);
    crearEnemigos(spawnArea, posicionX, posicionZ);
    crearPiedras(spawnArea, posicionX, posicionZ);
    crearMercado(spawnArea, posicionX, posicionZ);
  }
  function crearCajas() {
    for (let j = 0; j < cantidadCajas; j++) {
      // crear una caja TESTING
      const geoBox = new THREE.BoxGeometry(1, 1, 1);
      var r1 = Math.floor(Math.random() * (80 - 10)) + 10;
      var r2 = Math.floor(Math.random() * (80 - 10)) + 10;
      var r3 = Math.floor(Math.random() * (80 - 10)) + 10;
      var aparienciaColor = "0x" + r1 + r2 + r3;
      const matBox = new THREE.MeshPhongMaterial({
        color: parseInt(aparienciaColor),
      });
      const box = new THREE.Mesh(geoBox, matBox);
      box.castShadow = true;
      box.receiveShadow = true;
      box.userData.draggable = true;
      box.userData.name = "Caja" + j;
      box.position.x =
        Math.floor(Math.random() * (spawnArea - 5 - -(spawnArea - 5))) +
        -(spawnArea - 5);
      box.position.y = 0.5;
      box.position.z =
        Math.floor(Math.random() * (spawnArea - 5 - -(spawnArea - 5))) +
        -(spawnArea - 5);
      scene.add(box);
      arraySolidos.push(box);
    }
  }
  function crearPiedras(spawnArea, posicionX, posicionZ) {
    var cantidadPiedras = Math.floor(Math.random() * (3 - 0)) + 0;
    for (let j = 0; j < cantidadPiedras; j++) {
      const geometriaPiedra = new THREE.BoxGeometry(2, 2, 2);
      var randomSkin = Math.floor(Math.random() * (7 - 1) + 1);
      new GLTFLoader().load(
        "models/piedra/" + randomSkin + ".glb",
        function (gltf) {
          var nombrePiedra =
            "piedra" +
            (Math.floor(Math.random() * (999999 - 0)) + 0) *
              (Math.floor(Math.random() * (10 - 1)) + 1);
          var piedra = gltf.scene;
          piedra.traverse(function (object) {
            if (object.isMesh) object.castShadow = true;

            object.userData.draggable = true;
            object.name = nombrePiedra;
            object.userData = {
              draggable: true,
              name: nombrePiedra,
              tipo: "piedra",
            };
          });
          var random = Math.floor(Math.random() * (250 - 0)) + 0;
          piedra.rotation.y = random;
          piedra.geometry = geometriaPiedra;
          piedra.scale.set(2, 2, 2);
          piedra.castShadow = true;
          piedra.receiveShadow = true;
          piedra.position.x =
            Math.floor(Math.random() * (spawnArea - 5 - -(spawnArea - 5))) +
            -(spawnArea - 5);
          piedra.position.y = 0;
          piedra.position.z =
            Math.floor(Math.random() * (spawnArea - 5 - -(spawnArea - 5))) +
            -(spawnArea - 5);

          piedra.position.x += posicionX;
          piedra.position.z += posicionZ;
          scene.add(piedra);
          arraySolidos.push(piedra);
          camera.updateProjectionMatrix();
        }
      );
    }
  }
  function crearCofres(spawnArea, posicionX, posicionZ) {
    var cantidadCofres = Math.floor(Math.random() * (3 - 0)) + 0;
    for (let j = 0; j < cantidadCofres; j++) {
      var geo = new THREE.BoxGeometry(2, 2, 2);
      // crear un cofre
      new GLTFLoader().load("models/cofre.glb", function (gltf) {
        var random = Math.floor(Math.random() * (800 - 0)) + 0 + j;
        const cofre = gltf.scene;
        cofre.traverse(function (object) {
          if (object.isMesh) object.castShadow = true;

          object.userData.draggable = true;
          object.name = "Cofre" + random;
          object.userData = {
            draggable: false,
            name: "Cofre" + random,
            tipo: "cofre",
            estado: "cerrado",
          };
        });
        var random = Math.floor(Math.random() * (250 - 0)) + 0;
        cofre.rotation.y = random;
        cofre.geometry = geo;
        cofre.scale.set(1.5, 1.5, 1.5);
        cofre.castShadow = true;
        cofre.receiveShadow = true;
        cofre.position.x =
          Math.floor(Math.random() * (spawnArea - 5 - -(spawnArea - 5))) +
          -(spawnArea - 5);
        cofre.position.y = 0;
        cofre.position.z =
          Math.floor(Math.random() * (spawnArea - 5 - -(spawnArea - 5))) +
          -(spawnArea - 5);
        cofre.position.x += posicionX;
        cofre.position.z += posicionZ;
        scene.add(cofre);
        arraySolidos.push(cofre);
        camera.updateProjectionMatrix();
      });
    }
  }
  function crearParedes(tama√±oCuarto, posicionX, posicionZ) {
    // crear una pared
    const geoBox = new THREE.BoxGeometry(tama√±oCuarto, 10, 1);
    var loader = new THREE.TextureLoader();
    var texture2 = loader.load("img/pared.jpg", function (texture) {
      texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
      texture.offset.set(0, 0);
      texture.repeat.set(20, 5);
    });
    var materialPared = new THREE.MeshPhongMaterial({
      color: 0xffffff,
      specular: 0x111111,
      shininess: 10,
      map: texture2,
    });
    //pared ATRAS
    const pared = new THREE.Mesh(geoBox, materialPared);
    pared.castShadow = true;
    pared.receiveShadow = true;
    pared.userData.name = "Pared";
    pared.position.x = 0 + posicionX;
    pared.position.y = 0;
    pared.position.z = tama√±oCuarto / 2 + posicionZ;
    scene.add(pared);
    arrayParedes.push(pared);
    crearPuerta("atras", pared.position.x, pared.position.z);
    // arraySolidos.push(pared);
    camera.updateProjectionMatrix();
    //pared DERECHA
    const geoBox2 = new THREE.BoxGeometry(1, 10, tama√±oCuarto);
    const pared2 = new THREE.Mesh(geoBox2, materialPared);
    pared2.castShadow = true;
    pared2.receiveShadow = true;
    pared2.userData.name = "Pared2";
    pared2.position.x = tama√±oCuarto / 2 + posicionX;
    pared2.position.y = 0;
    pared2.position.z = 0 + posicionZ;
    scene.add(pared2);
    crearPuerta("derecha", pared2.position.x, pared2.position.z);
    arrayParedes.push(pared2);
    // arraySolidos.push(pared2);
    camera.updateProjectionMatrix();
    const geoBox3 = new THREE.BoxGeometry(1, 10, tama√±oCuarto);
    const pared3 = new THREE.Mesh(geoBox3, materialPared);
    pared3.castShadow = true;
    pared3.receiveShadow = true;
    pared3.userData.name = "Pared3";
    pared3.position.x = -tama√±oCuarto / 2 + posicionX;
    pared3.position.y = 0;
    pared3.position.z = 0 + posicionZ;
    scene.add(pared3);
    arrayParedes.push(pared3);
    // arraySolidos.push(pared3);
    camera.updateProjectionMatrix();
    const geoBox4 = new THREE.BoxGeometry(tama√±oCuarto, 10, 1);
    const pared4 = new THREE.Mesh(geoBox4, materialPared);
    pared4.castShadow = true;
    pared4.receiveShadow = true;
    pared4.userData.name = "Pared4";
    pared4.position.x = 0 + posicionX;
    pared4.position.y = 0;
    pared4.position.z = -tama√±oCuarto / 2 + posicionZ;
    scene.add(pared4);
    arrayParedes.push(pared4);
    // arraySolidos.push(pared4);
    pared.userData.ground = false;
    pared2.userData.ground = false;
    pared3.userData.ground = false;
    pared4.userData.ground = false;
    pared.userData.pared = true;
    pared2.userData.pared = true;
    pared3.userData.pared = true;
    pared4.userData.pared = true;
    camera.updateProjectionMatrix();
  }
  // CONTROL KEYS
  const keysPressed = {};
  document.addEventListener(
    "keydown",
    (event) => {
      if (event.shiftKey && characterControls) {
        characterControls.switchRunToggle();
      } else {
        keysPressed[event.key.toLowerCase()] = true;
      }
    },
    false
  );
  // ESCUCHANDO TECLAS
  document.body.onkeydown = function (e) {
    if (e.keyCode == 32) {
      characterControls.switchAtacar();
      sonidoAtacarFlag = 1;
      jugadorAtacando = 1;
      sonidoAtacar();
    }
    if (e.keyCode == 17) {
      characterControls.switchRoll();
      sonidoRoll();
    }
    if (e.keyCode == 69) {
      //E
      characterControls.switchRoll();
      sonidoRoll();
    }
    if (e.keyCode == 73) {
      //I (inventario)
      abrirInventario();
    }
    if (e.keyCode == 27) {
      //ESC (cerrar inventario)
      preferencesClose();
      cerrarMercado();
    }
    if (
      e.keyCode == 65 ||
      e.keyCode == 83 ||
      e.keyCode == 68 ||
      e.keyCode == 87
    ) {
      //A S D W
      sonidoCorrerFlag = 1;
      sonidoCaminar();
    }
  };
  document.body.onkeyup = function (e) {
    if (e.keyCode == 32) {
      characterControls.switchAtacarStop();
      jugadorAtacando = 0;
      sonidoAtacarStop();
    }
    if (e.keyCode == 17) {
      characterControls.switchRollStop();
    }
    if (e.keyCode == 69) {
      //E
      characterControls.switchRollStop();
    }
    if (
      e.keyCode == 65 ||
      e.keyCode == 83 ||
      e.keyCode == 68 ||
      e.keyCode == 87
    ) {
      //A S D W
      sonidoCaminarStop();
    }
  };
  document.addEventListener(
    "keyup",
    (event) => {
      keysPressed[event.key.toLowerCase()] = false;
    },
    false
  );
  const clock = new THREE.Clock();
  // RESIZE HANDLER
  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }
  window.addEventListener("resize", onWindowResize);

  function crearSuelo(tama√±oCuarto, posicionX, posicionZ) {
    const geoPiso = new THREE.PlaneGeometry(
      tama√±oCuarto,
      tama√±oCuarto,
      tama√±oCuarto
    );
    const matPiso = new THREE.MeshPhongMaterial({ color: 0x606060 });
    var loader = new THREE.TextureLoader();
    var material = new THREE.MeshLambertMaterial({
      map: loader.load("img/piso.jpg"),
    });
    var texture = loader.load("img/piso2.jpg", function (texture) {
      texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
      texture.offset.set(0, 0);
      texture.repeat.set(20, 20);
    });
    var materialPiso = new THREE.MeshPhongMaterial({
      color: 0xffffff,
      specular: 0x111111,
      shininess: 10,
      map: texture,
    });
    const pisoSimple = new THREE.Mesh(geoPiso, materialPiso);
    pisoSimple.castShadow = true;
    pisoSimple.receiveShadow = true;
    pisoSimple.rotation.x = -Math.PI / 2;
    pisoSimple.userData.ground = true;
    pisoSimple.position.set(posicionX, 0, posicionZ);
    scene.add(pisoSimple);
  }

  var luzGeneral = new THREE.AmbientLight(0x6fa8dc, 0.8);
  luzGeneral.position.set(0, 10, 0);
  luzGeneral.name = "luzGeneral";
  scene.add(luzGeneral);

  const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
  dirLight.position.set(-50, 50, 0);
  dirLight.castShadow = true;
  dirLight.shadow.camera.top = 100;
  dirLight.shadow.camera.bottom = -100;
  dirLight.shadow.camera.left = -100;
  dirLight.shadow.camera.right = 100;
  dirLight.shadow.camera.near = 0.1;
  dirLight.shadow.camera.far = 100;
  dirLight.shadow.mapSize.width = 4096;
  dirLight.shadow.mapSize.height = 4096;
  scene.add(dirLight);
  // ANIMATE
  function animate() {
    stats.begin();
    draggObj();
    animarBuffer();
    lucesAnimar();
    duracionBuffer();
    coolDown();
    horaActual();
    let mixerUpdateDelta = clock.getDelta();
    if (characterControls) {
      characterControls.update(mixerUpdateDelta, keysPressed);
    }
    orbitControls.update();
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
    chequearChoque();
    chequearEntrarPuerta();
    moverEnemigos();
    chequearRecibirDa√±o();
    chequearMorir();
    chequearChoqueParedes();
    if (jugador?.position != undefined) {
    dirLight.lookAt(jugador)
    }
    stats.end();
  }
  animate();
  document.body.appendChild(renderer.domElement);
  function horaActual() {
    var speed = 10000;
    let clockDiv = document.querySelector("#clock");
    let sec = Math.floor(gameTime / 1000) % 60;
    let min = Math.floor(gameTime / 60000) % 60;
    let hour = Math.floor(gameTime / 3600000) % 24;
    clockDiv.textContent = `${hour}:${min}`.replace(/\b\d\b/g, "0$&");
    gameTime += speed;
  }

  //Crear Skybox, unica vez
  let materialArray = [];
  let texture_up = new THREE.TextureLoader().load("img/skybox/up.png");
  let texture_rt = new THREE.TextureLoader().load("img/skybox/rt.png");
  let texture_lf = new THREE.TextureLoader().load("img/skybox/lf.png");
  let texture_ft = new THREE.TextureLoader().load("img/skybox/ft.png");
  let texture_dn = new THREE.TextureLoader().load("img/skybox/dn.png");
  let texture_bk = new THREE.TextureLoader().load("img/skybox/bk.png");
  materialArray.push(new THREE.MeshBasicMaterial({ map: texture_ft }));
  materialArray.push(new THREE.MeshBasicMaterial({ map: texture_bk }));
  materialArray.push(new THREE.MeshBasicMaterial({ map: texture_up }));
  materialArray.push(new THREE.MeshBasicMaterial({ map: texture_dn }));
  materialArray.push(new THREE.MeshBasicMaterial({ map: texture_rt }));
  materialArray.push(new THREE.MeshBasicMaterial({ map: texture_lf }));
  for (let i = 0; i < 6; i++) materialArray[i].side = THREE.BackSide;
  var tama√±o = 200 * 3;
  let skyboxGeo = new THREE.BoxGeometry(tama√±o, tama√±o, tama√±o);
  var skybox = new THREE.Mesh(skyboxGeo, materialArray);
  skybox.castShadow = true;
  skybox.receiveShadow = true;
  skybox.name = "skybox";
  skybox.userData = {
    nombre: "universo",
    tipo: "infinito",
  };
  scene.add(skybox);

  function chequearChoque() {
    if (jugador?.position != undefined) {
      for (let index = 0; index < arraySolidos.length; index++) {
        var resultado = checkearSiSeTocaJugador(jugador, arraySolidos[index]);
        if (
          resultado == "derecha" &&
          arraySolidos[index].userData.name != "Pared2"
        ) {
          const frenar = new THREE.Vector3(0.5, 0, 0);
          jugador.position.add(frenar);
        }
        if (
          resultado == "izquierda" &&
          arraySolidos[index].userData.name != "Pared2"
        ) {
          const frenar = new THREE.Vector3(-0.5, 0, 0);
          jugador.position.add(frenar);
        }
        if (
          resultado == "arriba" &&
          arraySolidos[index].userData.name != "Pared2"
        ) {
          const frenar = new THREE.Vector3(0, 0, -0.5);
          jugador.position.add(frenar);
        }
        if (
          resultado == "abajo" &&
          arraySolidos[index].userData.name != "Pared2"
        ) {
          const frenar = new THREE.Vector3(0, 0, 0.5);
          jugador.position.add(frenar);
        }
      }
    }

    for (let index = 0; index < arraySolidos.length; index++) {
      for (let w = 0; w < arrayEnemigos.length; w++) {
        var resultado = checkearSiSeTocaJugador(
          arrayEnemigos[w],
          arraySolidos[index]
        );
        if (resultado == "derecha") {
          const frenar = new THREE.Vector3(0.5, 0, 0);
          arrayEnemigos[w].position.add(frenar);
        }
        if (resultado == "izquierda") {
          const frenar = new THREE.Vector3(-0.5, 0, 0);
          arrayEnemigos[w].position.add(frenar);
        }
        if (resultado == "arriba") {
          const frenar = new THREE.Vector3(0, 0, -0.5);
          arrayEnemigos[w].position.add(frenar);
        }
        if (resultado == "abajo") {
          const frenar = new THREE.Vector3(0, 0, 0.5);
          arrayEnemigos[w].position.add(frenar);
        }
      }
    }
  }
  function cargarInventario() {
    actualizarStatsJugador();
    var cartel = document.getElementById("inventarioARellenar");
    cartel.innerHTML = "";
    var div = document.createElement("div");
    div.setAttribute("class", "contenedorItems");
    div.setAttribute("id", "contenedorItems");
    cartel.appendChild(div);
    var contenedorItemsId = document.getElementById("contenedorItems");
    for (let index = 0; index < inventario.length; index++) {
      var div = document.createElement("div");
      div.setAttribute("class", "dropdown");
      div.setAttribute("id", "dropdownid");
      contenedorItemsId.appendChild(div);
      var equipo = document.getElementById("dropdownid");
      var boton = document.createElement("button");
      boton.setAttribute(
        "class",
        "dropbtn casillero animate__animated animate__fadeIn"
      );
      boton.setAttribute("id", "boton" + index);
      boton.style.backgroundImage =
        "url(" + JSON.stringify(inventario[index].parent.userData.imagen) + ")";
      boton.style.backgroundSize = "contain";
      boton.style.backgroundRepeat = "no-repeat";
      boton.style.backgroundPosition = "center";
      equipo.appendChild(boton);
      var div = document.createElement("div");
      div.setAttribute("class", "dropdown-content");
      div.setAttribute("id", "dropdown-contentId" + index);
      equipo.appendChild(div);
      var desplegable = document.getElementById("dropdown-contentId" + index);
      let eventoBoton = document.getElementById("boton" + index);
      eventoBoton.addEventListener(
        "click",
        function (event) {
          var desplegableItem = document.getElementById(
            "dropdown-contentId" + index
          );
          desplegableItem.style.display = "block";
          var boton = document.getElementById("boton" + index);
          boton.style.backgroundColor = "#8bd48d94";
          var mouseX = event.clientX / window.innerWidth + 50;
          var mouseY = -(event.clientY / window.innerHeight) * 2 + 50;
          desplegableItem.style.top = mouseY + "px";
          desplegableItem.style.left = mouseX + "px";
        },
        false
      );
      eventoBoton.addEventListener(
        "mouseleave",
        function (event) {
          setTimeout(function () {
            var desplegable = document.getElementById(
              "dropdown-contentId" + index
            );
            desplegable.style.display = "none";
            var boton = document.getElementById("boton" + index);
            boton.style.backgroundColor = "";
          }, 3000);
        },
        false
      );
      var link = document.createElement("a");
      link.innerHTML = "Usar";
      link.setAttribute("class", "accionItemLeyenda");
      link.setAttribute("onclick", "opcionesItemInventario(" + index + ")");
      desplegable.appendChild(link);
      var link = document.createElement("a");
      link.innerHTML = "Tirar";
      link.setAttribute("class", "accionItemLeyenda");
      link.setAttribute("onclick", "opcionesItemInventarioDrop(" + index + ")");
      desplegable.appendChild(link);
      var info = document.createElement("div");
      info.setAttribute("id", "info" + index);
      info.setAttribute("class", "infoArma");
      desplegable.appendChild(info);
      var infoId = document.getElementById("info" + index);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        inventario[index].parent.userData.nombre.toUpperCase();
      infoId.appendChild(infoItem);
      if (
        inventario[index].parent.userData.categoria != "pocion" ||
        inventario[index].parent.userData.nombre != "Pocion"
      ) {
        var infoItem = document.createElement("p");
        infoItem.innerHTML =
          "‚öîÔ∏è ATK: " + inventario[index].parent.userData.ataque;
        infoId.appendChild(infoItem);
        var infoItem = document.createElement("p");
        infoItem.innerHTML =
          "üõ°Ô∏è DEF: " + inventario[index].parent.userData.defensa;
        infoId.appendChild(infoItem);
        var infoItem = document.createElement("p");
        infoItem.innerHTML = "‚öñÔ∏è WT: " + inventario[index].parent.userData.peso;
        infoId.appendChild(infoItem);
      } else {
        var infoItem = document.createElement("p");
        infoItem.innerHTML =
          "üç∑ QTY: " + inventario[index].parent.userData.cantidad;
        infoId.appendChild(infoItem);
      }
    }
    var boton = document.createElement("button");
    boton.setAttribute("class", "botonSave");
    boton.setAttribute("onclick", "preferencesClose()");
    boton.innerHTML = "Cerrar";
    cartel.appendChild(boton);
  }
  window.opcionesItemInventario = opcionesItemInventario;
  window.opcionesItemInventarioDrop = opcionesItemInventarioDrop;
  function opcionesItemInventario(index) {
    if (inventario[index]?.parent?.userData?.categoria == "pocion") {
      jugadorStats.salud += inventario[index]?.parent?.userData?.cantidad;
      inventario.splice(index, 1);
      sonidoDropPocion();
    }
    if (
      inventario[index]?.parent?.userData?.categoria == "armadura" &&
      jugadorEquipoEnUso.armadura == ""
    ) {
      jugadorEquipoEnUso.armadura = inventario[index];
      inventario.splice(index, 1);
      sonidoDropArmadura();
    }
    if (
      inventario[index]?.parent?.userData?.categoria == "armadura" &&
      jugadorEquipoEnUso.armadura != ""
    ) {
      inventario.push(jugadorEquipoEnUso.armadura);
      jugadorEquipoEnUso.armadura = inventario[index];
      inventario.splice(index, 1);
      sonidoJuntar();
      sonidoDropArmadura();
    }
    if (
      inventario[index]?.parent?.userData?.categoria == "arma" &&
      jugadorEquipoEnUso.arma == ""
    ) {
      jugadorEquipoEnUso.arma = inventario[index];
      inventario.splice(index, 1);
      sonidoDropArma();
    }
    if (
      inventario[index]?.parent?.userData?.categoria == "arma" &&
      jugadorEquipoEnUso.arma != ""
    ) {
      inventario.push(jugadorEquipoEnUso.arma);
      jugadorEquipoEnUso.arma = inventario[index];
      inventario.splice(index, 1);
      sonidoJuntar();
      sonidoDropArma();
    }
    if (
      inventario[index]?.parent?.userData?.categoria == "anillo" &&
      jugadorEquipoEnUso.anillo == ""
    ) {
      jugadorEquipoEnUso.anillo = inventario[index];
      inventario.splice(index, 1);
      sonidoDropAnillo();
    }
    if (
      inventario[index]?.parent?.userData?.categoria == "anillo" &&
      jugadorEquipoEnUso.anillo != ""
    ) {
      inventario.push(jugadorEquipoEnUso.anillo);
      jugadorEquipoEnUso.anillo = inventario[index];
      inventario.splice(index, 1);
      sonidoJuntar();
      sonidoDropAnillo();
    }
    if (
      inventario[index]?.parent?.userData?.categoria == "collar" &&
      jugadorEquipoEnUso.collar == ""
    ) {
      jugadorEquipoEnUso.collar = inventario[index];
      inventario.splice(index, 1);
      sonidoDropCollar();
    }
    if (
      inventario[index]?.parent?.userData?.categoria == "collar" &&
      jugadorEquipoEnUso.collar != ""
    ) {
      inventario.push(jugadorEquipoEnUso.collar);
      jugadorEquipoEnUso.collar = inventario[index];
      inventario.splice(index, 1);
      sonidoJuntar();
      sonidoDropCollar();
    }
    cargarInventario();
    cargarEquipo();
  }
  function sacarItemPuesto(tipo) {
    if (tipo == "armadura" && jugadorEquipoEnUso.armadura != "") {
      inventario.push(jugadorEquipoEnUso.armadura);
      jugadorEquipoEnUso.armadura = "";
      sonidoDropArmadura();
    }
    if (tipo == "arma" && jugadorEquipoEnUso.arma != "") {
      inventario.push(jugadorEquipoEnUso.arma);
      jugadorEquipoEnUso.arma = "";
      sonidoDropArma();
    }
    if (tipo == "collar" && jugadorEquipoEnUso.collar != "") {
      inventario.push(jugadorEquipoEnUso.collar);
      jugadorEquipoEnUso.collar = "";
      sonidoDropCollar();
    }
    if (tipo == "anillo" && jugadorEquipoEnUso.anillo != "") {
      inventario.push(jugadorEquipoEnUso.anillo);
      jugadorEquipoEnUso.anillo = "";
      sonidoDropAnillo();
    }
    actualizarStatsJugador();
    cargarInventario();
    cargarEquipo();
  }
  function cargarEquipo() {
    var armaduraId = document.getElementById("contenedorArmadura");
    var armaId = document.getElementById("contenedorArma");
    var anilloId = document.getElementById("contenedorAnillo");
    var collarId = document.getElementById("contenedorCollar");
    if (jugadorEquipoEnUso.armadura != "") {
      armaduraId.style.backgroundImage = "url(img/item/armadura.png)";
    } else {
      armaduraId.style.backgroundImage = "";
    }
    if (jugadorEquipoEnUso.arma != "") {
      armaId.style.backgroundImage = "url(img/item/arma.png)";
    } else {
      armaId.style.backgroundImage = "";
    }
    if (jugadorEquipoEnUso.anillo != "") {
      anilloId.style.backgroundImage = "url(img/item/anillo.png)";
    } else {
      anilloId.style.backgroundImage = "";
    }
    if (jugadorEquipoEnUso.collar != "") {
      collarId.style.backgroundImage = "url(img/item/collar.png)";
    } else {
      collarId.style.backgroundImage = "";
    }
  }
  function opcionesItemInventarioDrop(index) {
    tirarLoot(inventario[index]);
    inventario.splice(index, 1);
    sonidoJuntar();
    cargarInventario();
  }
  function abrirInventario() {
    var cartel = document.getElementById("optionsMenu");
    if (cartel.style.display == "block") {
      cartel.style.display = "none";
    } else {
      cartel.style.display = "block";
    }
  }
  function abrirCofre(objeto) {
    sonidoCofre();
    acumularExperiencia("juntar");
    var randomCantidad = Math.floor(Math.random() * (7 - 0)) + 0;
    crearLoot(objeto, randomCantidad);
    var geo = new THREE.BoxGeometry(2, 2, 2);
    var posX = objeto.position.x;
    var posZ = objeto.position.z;
    // crear un cofre
    new GLTFLoader().load("models/cofreabierto.glb", function (gltf) {
      var random = Math.floor(Math.random() * (800 - 0)) + 0;
      const cofre = gltf.scene;
      cofre.traverse(function (object) {
        if (object.isMesh) object.castShadow = true;
        object.userData.draggable = true;
        object.name = "Cofre" + random;
        cofre.position.set(posX, 0, posZ);
        object.userData = {
          draggable: false,
          name: "Cofre" + random,
          tipo: "cofre",
          estado: "abierto",
        };
      });
      cofre.name = "Cofre" + random;
      cofre.rotation.y = objeto.rotation.y;
      cofre.geometry = geo;
      cofre.scale.set(1.5, 1.5, 1.5);
      cofre.position.set(posX, 0, posZ);
      cofre.castShadow = true;
      cofre.receiveShadow = true;
      scene.add(cofre);
      camera.updateProjectionMatrix();
    });
    camera.updateProjectionMatrix();
    scene.remove(objeto);
  }
  function crearLoot(objeto, cantidad) {
    for (let index = 0; index < cantidad; index++) {
      var posX = objeto.position.x;
      var posZ = objeto.position.z;
      var randomItem = Math.floor(Math.random() * (8 - 1)) + 1;
      var tipoDeItem = Math.floor(Math.random() * (7 - 1)) + 1;
      if (tipoDeItem == 1) {
        var resultadoItem = devolverItemParaLootArmadura(randomItem);
        sonidoDropArmadura();
      }
      if (tipoDeItem == 2) {
        var resultadoItem = devolverItemParaLootArma(randomItem);
        sonidoDropArma();
      }
      if (tipoDeItem == 3) {
        var resultadoItem = devolverItemParaLootAnillo(randomItem);
        sonidoDropAnillo();
      }
      if (tipoDeItem == 4) {
        var resultadoItem = devolverItemParaLootCollar(randomItem);
        sonidoDropCollar();
      }
      if (tipoDeItem == 5) {
        var resultadoItem = devolverItemParaLootPocion(randomItem);
        sonidoDropPocion();
      }
      if (tipoDeItem == 6) {
        var resultadoItem = devolverItemParaLootMoneda(randomItem);
        sonidoDropMoneda();
      }
      new GLTFLoader().load(resultadoItem + ".glb", function (gltf) {
        const loot = gltf.scene;
        loot.traverse(function (object) {
          if (object.isMesh) object.castShadow = true;
        });
        var randomPosX = Math.floor(Math.random() * (3 - -3)) + -3;
        var randomPosZ = Math.floor(Math.random() * (3 - -3)) + -3;
        var geo = new THREE.BoxGeometry(1, 1, 1);
        loot.position.set(posX + randomPosX, 0.1, posZ + randomPosZ);
        loot.geometry = geo;
        loot.scale.set(0.8, 0.8, 0.8);
        var random = Math.floor(Math.random() * (250 - 0)) + 0;
        var tipo = tipoLootSegunNombreObjeto3D(loot.children[0].name);
        if (tipo != "moneda") {
          loot.rotation.x = -Math.PI / 2;
          loot.rotation.z = random;
        }
        if (tipo == "anillo") {
          loot.scale.set(0.4, 0.4, 0.4);
        }
        if (tipo == "pocion") {
          loot.scale.set(0.4, 0.4, 0.4);
        }
        if (tipo == "moneda") {
          loot.userData = {
            nombre: "Monedas",
            cantidad: Math.floor(Math.random() * (250 - 10)) + 10,
            tipo: "recurso",
            categoria: "moneda",
            imagen: "img/item/moneda.png",
            peso: 0,
          };
        }
        if (tipo == "pocion") {
          loot.userData = {
            nombre: "Pocion",
            peso: 3,
            cantidad: Math.floor(Math.random() * (250 - 10)) + 10,
            tipo: "recurso",
            categoria: "pocion",
            imagen: "img/item/pocion.png",
          };
        }
        if (tipo == "armadura") {
          var nombreRandom =
            lootArrayArmadura[
              Math.floor(Math.random() * (lootArrayArmadura.length - 0)) + 0
            ];
          loot.userData = {
            nombre: nombreRandom,
            ataque:
              (Math.floor(Math.random() * (5 - 1)) + 1) * jugadorStats.nivel,
            defensa:
              (Math.floor(Math.random() * (5 - 1)) + 1) * jugadorStats.nivel,
            peso: Math.floor(Math.random() * (100 - 1)) + 1,
            tipo: "recurso",
            categoria: "armadura",
            imagen: "img/item/armadura.png",
            glb: resultadoItem,
          };
        }
        if (tipo == "arma") {
          var nombreRandom =
            lootArrayArma[
              Math.floor(Math.random() * (lootArrayArma.length - 0)) + 0
            ];
          loot.userData = {
            nombre: nombreRandom,
            ataque:
              (Math.floor(Math.random() * (10 - 1)) + 1) * jugadorStats.nivel,
            defensa:
              (Math.floor(Math.random() * (10 - 1)) + 1) * jugadorStats.nivel,
            peso: Math.floor(Math.random() * (100 - 1)) + 1,
            tipo: "recurso",
            categoria: "arma",
            imagen: "img/item/arma.png",
            glb: resultadoItem,
          };
        }
        if (tipo == "collar") {
          var nombreRandom =
            lootArrayCollar[
              Math.floor(Math.random() * (lootArrayCollar.length - 0)) + 0
            ];
          loot.userData = {
            nombre: nombreRandom,
            ataque:
              (Math.floor(Math.random() * (5 - 1)) + 1) * jugadorStats.nivel,
            defensa:
              (Math.floor(Math.random() * (5 - 1)) + 1) * jugadorStats.nivel,
            peso: Math.floor(Math.random() * (5 - 1)) + 1,
            tipo: "recurso",
            categoria: "collar",
            imagen: "img/item/collar.png",
            glb: resultadoItem,
          };
        }
        if (tipo == "anillo") {
          var nombreRandom =
            lootArrayAnillo[
              Math.floor(Math.random() * (lootArrayAnillo.length - 0)) + 0
            ];
          loot.userData = {
            nombre: nombreRandom,
            ataque:
              (Math.floor(Math.random() * (5 - 1)) + 1) * jugadorStats.nivel,
            defensa:
              (Math.floor(Math.random() * (5 - 1)) + 1) * jugadorStats.nivel,
            peso: Math.floor(Math.random() * (3 - 1)) + 1,
            tipo: "recurso",
            categoria: "anillo",
            imagen: "img/item/anillo.png",
            glb: resultadoItem,
          };
        }
        var nombreRandomParaBorrar =
          "objeto" +
          (Math.floor(Math.random() * (999999 - 0)) + 0) *
            (Math.floor(Math.random() * (10 - 1)) + 1);
        loot.name = nombreRandomParaBorrar;
        scene.add(loot);
      });
    }
  }
  function tipoLootSegunNombreObjeto3D(objeto) {
    if (objeto.includes("Ingots")) {
      return "moneda";
    }
    if (objeto.includes("Armor")) {
      return "armadura";
    }
    if (
      objeto.includes("Sword") ||
      objeto.includes("Dagger") ||
      objeto.includes("Axe") ||
      objeto.includes("Hammer")
    ) {
      return "arma";
    }
    if (objeto.includes("Necklace")) {
      return "collar";
    }
    if (objeto.includes("Ring")) {
      return "anillo";
    }
    if (objeto.includes("Potion")) {
      return "pocion";
    }
  }
  function devolverItemParaLootArmadura(randomItem) {
    var resultadoItem;
    switch (randomItem) {
      case 1:
        resultadoItem = "models/armadura/acero";
        break;
      case 2:
        resultadoItem = "models/armadura/negra";
      case 3:
        resultadoItem = "models/armadura/piel";
        break;
      case 4:
        resultadoItem = "models/armadura/oro";
        break;
      case 5:
        resultadoItem = "models/armadura/metal";
        break;
      default:
        resultadoItem = "models/armadura/piel";
    }
    return resultadoItem;
  }
  function devolverItemParaLootArma(randomItem) {
    var resultadoItem;
    switch (randomItem) {
      case 1:
        resultadoItem = "models/arma/daga";
        break;
      case 2:
        resultadoItem = "models/arma/espada";
      case 3:
        resultadoItem = "models/arma/espadagrande";
        break;
      case 4:
        resultadoItem = "models/arma/hacha";
        break;
      case 5:
        resultadoItem = "models/arma/hachadobleoro";
        break;
      case 6:
        resultadoItem = "models/arma/hachaoro";
        break;
      case 7:
        resultadoItem = "models/arma/martillooro";
        break;
      default:
        resultadoItem = "models/arma/daga";
    }
    return resultadoItem;
  }
  function devolverItemParaLootAnillo(randomItem) {
    var resultadoItem;
    switch (randomItem) {
      case 1:
        resultadoItem = "models/anillo/anillo1";
        break;
      case 2:
        resultadoItem = "models/anillo/anillo2";
      case 3:
        resultadoItem = "models/anillo/anillo3";
        break;
      case 4:
        resultadoItem = "models/anillo/anillo4";
        break;
      default:
        resultadoItem = "models/anillo/anillo1";
    }
    return resultadoItem;
  }
  function devolverItemParaLootCollar(randomItem) {
    var resultadoItem;
    switch (randomItem) {
      case 1:
        resultadoItem = "models/collar/collar1";
        break;
      case 2:
        resultadoItem = "models/collar/collar2";
      case 3:
        resultadoItem = "models/collar/collar3";
        break;
      default:
        resultadoItem = "models/collar/collar1";
    }
    return resultadoItem;
  }
  function devolverItemParaLootPocion(randomItem) {
    var resultadoItem;
    switch (randomItem) {
      case 1:
        resultadoItem = "models/pocion/pocion";
        break;
      default:
        resultadoItem = "models/pocion/pocion";
    }
    return resultadoItem;
  }
  function devolverItemParaLootMoneda(randomItem) {
    var resultadoItem;
    switch (randomItem) {
      case 1:
        resultadoItem = "models/moneda/moneda1";
        break;
      default:
        resultadoItem = "models/moneda/moneda1";
    }
    return resultadoItem;
  }
  function varSiPuedeLevantarLoot(objeto) {
    if (jugadorStats.peso + objeto.parent.userData.peso <= 200) {
      sonidoJuntar();
      if (objeto.parent.userData.categoria != "moneda") {
        inventario.push(objeto);
        var selectedObject = scene.getObjectByName(objeto.parent.name);
        scene.remove(selectedObject);
        actualizarStatsJugador();
        cargarInventario();
      }
      if (objeto.parent.userData.categoria == "moneda") {
        jugadorStats.monedas += objeto.parent.userData.cantidad;
        var selectedObject = scene.getObjectByName(objeto.parent.name);
        scene.remove(selectedObject);
        actualizarStatsJugador();
        cargarInventario();
      }
    } else {
      document.getElementById("noHayEspacio").style.display = "block";
      setTimeout(function () {
        document.getElementById("noHayEspacio").style.display = "none";
      }, 3000);
    }
  }
  function actualizarStatsJugador() {
    var acumuladorPeso = 0;
    var arrayAcumuladorAtaque = [];
    var arrayAcumuladorPeso = [];
    var arrayAcumuladorDefensa = [];
    var totalAtaque = 0;
    var totalDefensa = 0;
    arrayAcumuladorAtaque.push(
      jugadorEquipoEnUso.armadura?.parent?.userData.ataque
    );
    arrayAcumuladorAtaque.push(
      jugadorEquipoEnUso.arma?.parent?.userData.ataque
    );
    arrayAcumuladorAtaque.push(
      jugadorEquipoEnUso.collar?.parent?.userData.ataque
    );
    arrayAcumuladorAtaque.push(
      jugadorEquipoEnUso.anillo?.parent?.userData.ataque
    );
    arrayAcumuladorDefensa.push(
      jugadorEquipoEnUso.armadura?.parent?.userData.defensa
    );
    arrayAcumuladorDefensa.push(
      jugadorEquipoEnUso.arma?.parent?.userData.defensa
    );
    arrayAcumuladorDefensa.push(
      jugadorEquipoEnUso.collar?.parent?.userData.defensa
    );
    arrayAcumuladorDefensa.push(
      jugadorEquipoEnUso.anillo?.parent?.userData.defensa
    );
    for (let i = 0; i < arrayAcumuladorAtaque.length; i++) {
      if (!isNaN(arrayAcumuladorAtaque[i])) {
        totalAtaque += arrayAcumuladorAtaque[i];
      }
      if (!isNaN(arrayAcumuladorDefensa[i])) {
        totalDefensa += arrayAcumuladorDefensa[i];
      }
    }
    for (let i = 0; i < inventario.length; i++) {
      acumuladorPeso += inventario[i].parent.userData.peso;
    }
    jugadorStats.peso = acumuladorPeso;

    document.getElementById("pesoId").innerHTML = jugadorStats.peso + "/200";

    jugadorStatsConEquipo.fuerza = jugadorStats.fuerza + totalAtaque;
    jugadorStatsConEquipo.defensa = jugadorStats.defensa + totalDefensa;
    document.getElementById("monedasId").innerHTML = jugadorStats.monedas;
    document.getElementById("fuerzaId").innerHTML =
      jugadorStatsConEquipo.fuerza;
    document.getElementById("defensaId").innerHTML =
      jugadorStatsConEquipo.defensa;
    document.getElementById("saludId").innerHTML = jugadorStats.salud;
    document.getElementById("saludBarra").innerHTML =
      "ü§ç " + jugadorStats.salud;

    document.getElementById("nivelId").innerHTML = jugadorStats.nivel;
    document.getElementById("experienciaId").innerHTML =
      jugadorStats.experiencia + "/100";
  }
  var audioCaminar = new Audio("audio/caminar.mp3");
  var audioAtacar = new Audio("audio/espada.mp3");
  var audioCofre = new Audio("audio/cofre.mp3");
  var audioRoll = new Audio("audio/roll.mp3");
  var musica = new Audio("audio/musica.mp3");
  var audioArmadura = new Audio("audio/dropArmadura.mp3");
  var audioArma = new Audio("audio/dropArma.mp3");
  var audioAnillo = new Audio("audio/dropAnillo.mp3");
  var audioCollar = new Audio("audio/dropCollar.mp3");
  var audioPocion = new Audio("audio/dropPocion.mp3");
  var audioMoneda = new Audio("audio/dropMoneda.mp3");
  var audioJuntar = new Audio("audio/juntar.mp3");

  function sonidoCaminar() {
    if (sonidoCorrerFlag == 1 && morir == 0) {
      audioCaminar.play();
    }
  }

  function sonidoHerirse() {
    var random = Math.floor(Math.random() * (3 - 1)) + 1;
    var audio = new Audio("audio/guerrero/" + random + ".mp3");
    audio.play();
  }
  function sonidoMorir() {
    if (sonidoMorirFlag == 0) {
      var audio = new Audio("audio/guerrero/morir.mp3");
      audio.play();
      sonidoMorirFlag = 1;
    }
  }

  function sonidoCaminarStop() {
    audioCaminar.pause();
    sonidoCorrerFlag = 0;
  }
  function sonidoAtacar() {
    if (sonidoAtacarFlag == 1) {
      audioAtacar.play();
    }
  }
  function sonidoAtacarStop() {
    audioAtacar.pause();
    sonidoAtacarFlag = 0;
  }
  function sonidoCofre() {
    audioCofre.play();
  }
  function sonidoRoll() {
    audioRoll.play();
  }
  function musicaPlay() {
    musica.play();
    musica.loop = true;
  }
  function sonidoJuntar() {
    audioJuntar.play();
  }
  function sonidoDropArmadura() {
    audioArmadura.play();
  }
  function sonidoDropArma() {
    audioArma.play();
  }
  function sonidoDropAnillo() {
    audioAnillo.play();
  }
  function sonidoDropCollar() {
    audioCollar.play();
  }
  function sonidoDropPocion() {
    audioPocion.play();
  }
  function sonidoDropMoneda() {
    audioMoneda.play();
  }

  function crearLuces(tama√±oCuarto, posicionX, posicionZ) {
    var anguloLuz = 1;
    var luz1 = new THREE.SpotLight(0xe69138, 0.01);
    luz1.position.set(tama√±oCuarto / 2 - 1, 2, tama√±oCuarto / 2 - 1);
    luz1.shadow.camera.far = 50;
    luz1.shadow.camera.near = 0.01;
    luz1.castShadow = true;
    luz1.angle = anguloLuz;
    luz1.castShadow = true;
    luz1.position.x += posicionX;
    luz1.position.z += posicionZ;
    arrayLuces.push(luz1);
    if (lucesSoloEnPrimerCuarto == 0) {
      scene.add(luz1);
    }
    var rotacion = 2 * Math.PI * (135 / 360);
    var despazamientoFuegoX = -0.5;
    var despazamientoFuegoZ = -0.5;
    crearAntorcha(
      tama√±oCuarto / 2 - 1,
      tama√±oCuarto / 2 - 1,
      rotacion,
      despazamientoFuegoX,
      despazamientoFuegoZ,
      posicionX,
      posicionZ
    );
    var luz2 = new THREE.SpotLight(0xe69138, 0.3);
    luz2.position.set(-(tama√±oCuarto / 2 - 1), 2, -(tama√±oCuarto / 2 - 1));
    luz2.shadow.camera.far = 50;
    luz2.shadow.camera.near = 0.01;
    luz2.angle = anguloLuz;
    luz2.castShadow = true;
    luz2.position.x += posicionX;
    luz2.position.z += posicionZ;
    arrayLuces.push(luz2);
    if (lucesSoloEnPrimerCuarto == 0) {
      scene.add(luz2);
    }
    var rotacion = 2 * Math.PI * (-45 / 360);
    var despazamientoFuegoX = +0.5;
    var despazamientoFuegoZ = +0.5;
    crearAntorcha(
      -(tama√±oCuarto / 2 - 1),
      -(tama√±oCuarto / 2 - 1),
      rotacion,
      despazamientoFuegoX,
      despazamientoFuegoZ,
      posicionX,
      posicionZ
    );
    var luz3 = new THREE.SpotLight(0xe69138, 1.5);
    luz3.position.set(tama√±oCuarto / 2 - 1, 2, -(tama√±oCuarto / 2 - 1));
    luz3.shadow.camera.far = 50;
    luz3.shadow.camera.near = 0.01;
    luz3.angle = anguloLuz;
    luz3.castShadow = true;
    luz3.position.x += posicionX;
    luz3.position.z += posicionZ;
    arrayLuces.push(luz3);
    if (lucesSoloEnPrimerCuarto == 0) {
      scene.add(luz3);
    }
    var rotacion = 2 * Math.PI * (225 / 360);
    var despazamientoFuegoX = -0.5;
    var despazamientoFuegoZ = +0.5;
    crearAntorcha(
      tama√±oCuarto / 2 - 1,
      -(tama√±oCuarto / 2 - 1),
      rotacion,
      despazamientoFuegoX,
      despazamientoFuegoZ,
      posicionX,
      posicionZ
    );
    var luz4 = new THREE.SpotLight(0xe69138, 0.7);
    luz4.position.set(-(tama√±oCuarto / 2 - 1), 2, tama√±oCuarto / 2 - 1);
    luz4.shadow.camera.far = 50;
    luz4.shadow.camera.near = 0.01;
    luz4.angle = anguloLuz;
    luz4.castShadow = true;
    luz4.position.x += posicionX;
    luz4.position.z += posicionZ;
    arrayLuces.push(luz4);
    if (lucesSoloEnPrimerCuarto == 0) {
      scene.add(luz4);
    }
    var rotacion = Math.PI / 4;
    var despazamientoFuegoX = 0.5;
    var despazamientoFuegoZ = -0.5;
    crearAntorcha(
      -(tama√±oCuarto / 2 - 1),
      tama√±oCuarto / 2 - 1,
      rotacion,
      despazamientoFuegoX,
      despazamientoFuegoZ,
      posicionX,
      posicionZ
    );
    lucesSoloEnPrimerCuarto = 1;
  }
  function lucesAnimar() {
    // for (let i = 0; i < arrayLuces.length; i++) {
    var colorLuz;
    var intensidad;
    var randomColorLuz = Math.floor(Math.random() * (100 - 0)) + 0;
    if (randomColorLuz == 1) {
      colorLuz = "0xCC0000";
    }
    if (randomColorLuz == 2) {
      colorLuz = "0xE69138";
    }
    if (randomColorLuz == 3) {
      colorLuz = "0xFFD966";
    } else {
      colorLuz = "0xF6B26B";
    }
    // arrayLuces[i].color = new THREE.Color(parseInt(colorLuz));
    // arrayLuces[i].intensity = intensidad

    // if (arrayLuces[i].intensity < 1.8 && fg == 1) {
    //   arrayLuces[i].intensity += 0.01;

    //   if (arrayLuces[i].intensity >= 1.8) {
    //     fg = 0;
    //   }
    // }
    // if (fg == 0) {
    //   arrayLuces[i].intensity -= 0.01;

    //   if (arrayLuces[i].intensity <= 0) {
    //     fg = 1;
    //   }
    // }
    for (let w = 0; w < arrayFuegos.length; w++) {
      var materialFuego = new THREE.MeshPhongMaterial({
        color: parseInt(colorLuz),
      });
      arrayFuegos[w].material = materialFuego;
      var flag = Math.floor(Math.random() * (20 - 1)) + 1;

      if (flag == 2) {
        var geo = new THREE.SphereGeometry(0.25, 0.15, 0.15);
      } else {
        var geo = new THREE.SphereGeometry(0.2, 0.1, 0.1);
      }
      if (flag == 4) {
        var geo = new THREE.SphereGeometry(0.23, 0.13, 0.13);
      }
      arrayFuegos[w].geometry = geo;
    }
  }
  // }
  function crearAntorcha(
    posX,
    posZ,
    rotacion,
    despazamientoFuegoX,
    despazamientoFuegoZ,
    posicionX,
    posicionZ
  ) {
    new GLTFLoader().load("models/torch.glb", function (gltf) {
      const test = gltf.scene;
      test.traverse(function (object) {
        if (object.isMesh) object.castShadow = true;
        var loader = new THREE.TextureLoader();
        var textura = loader.load("img/metal.jpg", function (texture) {
          texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
          texture.offset.set(0, 0);
          texture.repeat.set(100, 100);
        });
        var texturaMapeada = new THREE.MeshPhongMaterial({
          specular: 0x111111,
          shininess: 10,
          map: textura,
        });
        object.material = texturaMapeada;
      });
      var geo = new THREE.BoxGeometry(0.5, 0.5, 0.5);
      test.geometry = geo;
      test.position.x = posX;
      test.position.z = posZ;
      test.position.x += posicionX;
      test.position.z += posicionZ;
      test.position.y = 3;
      test.rotation.y = rotacion;
      test.scale.set(0.8, 0.8, 0.8);
      scene.add(test);
      arraySolidos.push(test);
    });
    const geometry = new THREE.SphereGeometry(0.2, 0.1, 0.1);
    const material = new THREE.MeshPhongMaterial({ color: 0xffff00 });
    const sphere = new THREE.Mesh(geometry, material);
    sphere.position.x = posX + despazamientoFuegoX;
    sphere.position.z = posZ + despazamientoFuegoZ;
    sphere.position.y = 3.6;
    sphere.position.x += posicionX;
    sphere.position.z += posicionZ;
    arrayFuegos.push(sphere);
    scene.add(sphere);
    crearColumna(
      posX - despazamientoFuegoX,
      posZ - despazamientoFuegoZ,
      posicionX,
      posicionZ
    );
  }
  function crearColumna(posX, posZ, posicionX, posicionZ) {
    new GLTFLoader().load("models/columna.glb", function (gltf) {
      const test = gltf.scene;
      test.traverse(function (object) {
        if (object.isMesh) object.castShadow = true;
        var loader = new THREE.TextureLoader();
        var textura = loader.load("img/test.jpg", function (texture) {
          texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
          texture.offset.set(0, 0);
          texture.repeat.set(500, 500);
        });
        var texturaMapeada = new THREE.MeshPhongMaterial({
          specular: 0x111111,
          shininess: 0.2,
          map: textura,
        });
        object.material = texturaMapeada;
      });
      var geo = new THREE.BoxGeometry(1, 2, 1);
      test.geometry = geo;
      test.position.x = posX;
      test.position.z = posZ;
      test.position.x += posicionX;
      test.position.z += posicionZ;
      test.scale.set(1, 1.24, 1);
      scene.add(test);
      arraySolidos.push(test);
    });
  }
  function verItemPuesto(item) {
    var vistaPreviaArmaduraId = document.getElementById("vistaPreviaArmadura");
    var vistaPreviaArmaId = document.getElementById("vistaPreviaArma");
    var vistaPreviaCollarId = document.getElementById("vistaPreviaCollar");
    var vistaPreviaAnilloId = document.getElementById("vistaPreviaAnillo");
    if (item == "armadura" && jugadorEquipoEnUso.armadura != "") {
      vistaPreviaArmaduraId.style.display = "block";
      vistaPreviaArmaduraId.innerHTML = "";
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        jugadorEquipoEnUso.armadura.parent.userData.nombre.toUpperCase();
      vistaPreviaArmaduraId.appendChild(infoItem);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        "‚öîÔ∏è ATK: " + jugadorEquipoEnUso.armadura.parent.userData.ataque;
      vistaPreviaArmaduraId.appendChild(infoItem);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        "üõ°Ô∏è DEF: " + jugadorEquipoEnUso.armadura.parent.userData.defensa;
      vistaPreviaArmaduraId.appendChild(infoItem);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        "‚öñÔ∏è WT: " + jugadorEquipoEnUso.armadura.parent.userData.peso;
      vistaPreviaArmaduraId.appendChild(infoItem);
    }
    if (item == "arma" && jugadorEquipoEnUso.arma != "") {
      vistaPreviaArmaId.style.display = "block";
      vistaPreviaArmaId.innerHTML = "";
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        jugadorEquipoEnUso.arma.parent.userData.nombre.toUpperCase();
      vistaPreviaArmaId.appendChild(infoItem);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        "‚öîÔ∏è ATK: " + jugadorEquipoEnUso.arma.parent.userData.ataque;
      vistaPreviaArmaId.appendChild(infoItem);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        "üõ°Ô∏è DEF: " + jugadorEquipoEnUso.arma.parent.userData.defensa;
      vistaPreviaArmaId.appendChild(infoItem);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        "‚öñÔ∏è WT: " + jugadorEquipoEnUso.arma.parent.userData.peso;
      vistaPreviaArmaId.appendChild(infoItem);
    }
    if (item == "anillo" && jugadorEquipoEnUso.anillo != "") {
      vistaPreviaAnilloId.style.display = "block";
      vistaPreviaAnilloId.innerHTML = "";
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        jugadorEquipoEnUso.anillo.parent.userData.nombre.toUpperCase();
      vistaPreviaAnilloId.appendChild(infoItem);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        "‚öîÔ∏è ATK: " + jugadorEquipoEnUso.anillo.parent.userData.ataque;
      vistaPreviaAnilloId.appendChild(infoItem);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        "üõ°Ô∏è DEF: " + jugadorEquipoEnUso.anillo.parent.userData.defensa;
      vistaPreviaAnilloId.appendChild(infoItem);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        "‚öñÔ∏è WT: " + jugadorEquipoEnUso.anillo.parent.userData.peso;
      vistaPreviaAnilloId.appendChild(infoItem);
    }
    if (item == "collar" && jugadorEquipoEnUso.collar != "") {
      vistaPreviaCollarId.style.display = "block";
      vistaPreviaCollarId.innerHTML = "";
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        jugadorEquipoEnUso.collar.parent.userData.nombre.toUpperCase();
      vistaPreviaCollarId.appendChild(infoItem);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        "‚öîÔ∏è ATK: " + jugadorEquipoEnUso.collar.parent.userData.ataque;
      vistaPreviaCollarId.appendChild(infoItem);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        "üõ°Ô∏è DEF: " + jugadorEquipoEnUso.collar.parent.userData.defensa;
      vistaPreviaCollarId.appendChild(infoItem);
      var infoItem = document.createElement("p");
      infoItem.innerHTML =
        "‚öñÔ∏è WT: " + jugadorEquipoEnUso.collar.parent.userData.peso;
      vistaPreviaCollarId.appendChild(infoItem);
    }
  }
  function verItemPuestoClose() {
    var vistaPreviaArmaduraId = document.getElementById("vistaPreviaArmadura");
    var vistaPreviaArmaId = document.getElementById("vistaPreviaArma");
    var vistaPreviaCollarId = document.getElementById("vistaPreviaCollar");
    var vistaPreviaAnilloId = document.getElementById("vistaPreviaAnillo");
    vistaPreviaArmaduraId.style.display = "none";
    vistaPreviaArmaId.style.display = "none";
    vistaPreviaCollarId.style.display = "none";
    vistaPreviaAnilloId.style.display = "none";
  }
  function tirarLoot(objeto) {
    var posX = jugador.position.x;
    var posZ = jugador.position.z;
    var resultadoItem = objeto.parent.userData.glb;
    new GLTFLoader().load(resultadoItem + ".glb", function (gltf) {
      const loot = gltf.scene;
      loot.traverse(function (object) {
        if (object.isMesh) object.castShadow = true;
      });
      var randomPosX = Math.floor(Math.random() * (3 - -3)) + -3;
      var randomPosZ = Math.floor(Math.random() * (3 - -3)) + -3;
      var geo = new THREE.BoxGeometry(1, 1, 1);
      loot.position.set(posX + randomPosX, 0.1, posZ + randomPosZ);
      loot.geometry = geo;
      loot.scale.set(0.8, 0.8, 0.8);
      loot.userData = {
        nombre: objeto.parent.userData.nombre,
        ataque: objeto.parent.userData.ataque,
        defensa: objeto.parent.userData.defensa,
        peso: objeto.parent.userData.peso,
        tipo: "recurso",
        categoria: objeto.parent.userData.categoria,
        imagen: objeto.parent.userData.imagen,
        glb: objeto.parent.userData.glb,
      };
      var nombreRandomParaBorrar =
        "objetoDevueltoAlMundo" +
        (Math.floor(Math.random() * (999999 - 0)) + 0) *
          (Math.floor(Math.random() * (10 - 1)) + 1);
      loot.name = nombreRandomParaBorrar;
      scene.add(loot);
    });
  }
  function crearEnemigos(spawnArea, posicionX, posicionZ) {
    var randomCantidadEnemigos = Math.floor(Math.random() * (3 - 0)) + 0;
    for (let w = 0; w < randomCantidadEnemigos; w++) {
      var randomSkin = Math.floor(Math.random() * (22 - 1)) + 1;
      new GLTFLoader().load(
        "models/enemigo/" + randomSkin + ".gltf",
        function (gltf) {
          const enemigo = gltf.scene;
          enemigo.traverse(function (object) {
            if (object.isMesh) object.castShadow = true;
          });
          var geo = new THREE.BoxGeometry(1, 2, 1);
          enemigo.geometry = geo;
          enemigo.position.x =
            Math.floor(Math.random() * (spawnArea - 5 - -(spawnArea - 5))) +
            -(spawnArea - 5);
          enemigo.position.y = 0;
          enemigo.position.z =
            Math.floor(Math.random() * (spawnArea - 5 - -(spawnArea - 5))) +
            -(spawnArea - 5);
          enemigo.scale.set(1, 1, 1);
          var velocidad = Math.random() * (0.06 - 0.01) + 0.01;

          enemigo.userData = {
            nombre: "Enemigo",
            salud: 100,
            ataque:
              (Math.floor(Math.random() * (3 - 1)) + 1) * jugadorStats.nivel,
            defensa:
              (Math.floor(Math.random() * (3 - 1)) + 1) * jugadorStats.nivel,
            velocidad: velocidad,
          };
          var nombreRandomParaBorrar =
            "enemigo" +
            (Math.floor(Math.random() * (999999 - 0)) + 0) *
              (Math.floor(Math.random() * (10 - 1)) + 1);
          enemigo.name = nombreRandomParaBorrar;

          enemigo.position.x += posicionX;
          enemigo.position.z += posicionZ;
          scene.add(enemigo);
          arrayEnemigos.push(enemigo);
          arraySolidos.push(enemigo);
        }
      );
    }
  }
  function moverEnemigos() {
    var posPjX = jugador?.position.x;
    var posPjZ = jugador?.position.z;
    if (morir == 0) {
      for (let i = 0; i < arrayEnemigos.length; i++) {
        var posCPUX = arrayEnemigos[i].position.x;
        var posCPUZ = arrayEnemigos[i].position.z;
        if (posPjX > posCPUX) {
          arrayEnemigos[i].position.x += arrayEnemigos[i].userData.velocidad;
        }
        if (posPjX < posCPUX) {
          arrayEnemigos[i].position.x -= arrayEnemigos[i].userData.velocidad;
        }
        if (posPjZ > posCPUZ) {
          arrayEnemigos[i].position.z += arrayEnemigos[i].userData.velocidad;
        }
        if (posPjZ < posCPUZ) {
          arrayEnemigos[i].position.z -= arrayEnemigos[i].userData.velocidad;
        }
        var vector = new THREE.Vector3(
          jugador.position.x,
          0,
          jugador.position.z
        );
        arrayEnemigos[i].lookAt(vector);
      }
    }
  }
  // function generarNuevaOrientacion() {
  //   return (direction = new THREE.Vector3(
  //     Math.random() * 2 - 1,
  //     1,
  //     Math.random() * 2 - 1
  //   ).normalize());
  // }
  // for (let j = 0; j < arrayEnemigos.length; j++) {
  //     var random = Math.floor(Math.random() * (200 - 0)) + 0;
  //     var orientacion = arrayEnemigos[j].userData.orientacion;
  //     var vel = arrayEnemigos[j].userData.velocidad;
  //     if (random == 10) {
  //       var nuevaOrientacion = generarNuevaOrientacion();
  //       shift.copy(nuevaOrientacion).multiplyScalar(vel);
  //       arrayEnemigos[j].position.add(shift);
  //       arrayEnemigos[j].userData.orientacion = nuevaOrientacion;
  //     } else {
  //       shift.copy(orientacion).multiplyScalar(vel);
  //       arrayEnemigos[j].position.add(shift);

  //     }
  //     //POR HACER
  //     // rotarSerAlMoverse(arraySeres[j]);
  //   }

  function chequearRecibirDa√±o() {
    if (jugador?.position != undefined) {
      for (let index = 0; index < arrayEnemigos.length; index++) {
        var resultado = checkearSiSeTocaJugador(jugador, arrayEnemigos[index]);
        if (resultado != false) {
          recibirDa√±o(arrayEnemigos[index]);
          animacionSerGolpeado();
          enemigoSonido();
        }
        if (resultado != false && jugadorAtacando == 1) {
          causarDa√±o(index);
        }
      }
    }
  }
  function animacionSerGolpeado() {
    characterControls.switchGolpeado();
    setTimeout(function () {
      characterControls.switchGolpeadoStop();
    }, 500);
  }
  function recibirDa√±o(enemigo) {
    if (enemigo.userData.ataque - jugadorStatsConEquipo.defensa <= 0) {
      var da√±o = 1;
    } else {
      var da√±o = enemigo.userData.ataque - jugadorStatsConEquipo.defensa;
    }

    jugadorStats.salud -= da√±o;
    actualizarStatsJugador();
  }

  function causarDa√±o(index) {
    if (bufferActivado === true) {
      var extraBuffer = 2;
    } else {
      var extraBuffer = 1;
    }
    arrayEnemigos[index].userData.salud -=
      jugadorStatsConEquipo.fuerza * extraBuffer;

    mostrarVidaEnemigo(arrayEnemigos[index].userData.salud);

    verSiMonstruoMuere(index);
  }
  function verSiMonstruoMuere(enemigo) {
    if (arrayEnemigos[enemigo].userData.salud <= 0) {
      acumularExperiencia("matar");
      var randomCantidad = Math.floor(Math.random() * (5 - 0)) + 0;
      var selectedObject = scene.getObjectByName(arrayEnemigos[enemigo].name);
      crearLoot(selectedObject, randomCantidad);

      scene.remove(selectedObject);
      var buscarEemigo = arraySolidos.indexOf(
        (elemento) => elemento.name == enemigo.name
      );
      arrayEnemigos.splice(enemigo, 1);
      arraySolidos.splice(buscarEemigo, 1);
    }
  }
  function chequearMorir() {
    if (jugador?.position != undefined) {
      if (jugadorStats.salud <= 0) {
        morir = 1;
        sonidoMorir();
        characterControls.switchMorir();
        bufferActivado = false;
        apagarLuces();
      }
      if (morir == 1) {
        setTimeout(function () {
          characterControls.switchMorirStop();
          jugador.rotation.x = -Math.PI / 2;
        }, 1000);
      }
    }
  }
  function enemigoSonido() {
    if (morir == 0) {
      var random = Math.floor(Math.random() * (5 - 1)) + 1;
      var audioEnemigo = new Audio("audio/enemigo/" + random + ".mp3");
      audioEnemigo.play();
    }
  }
  function buffer() {
    var pMaterial = new THREE.PointsMaterial({
      color: 0xcc0000,
      size: 10,
    });
    new GLTFLoader().load("models/arma/espada.glb", function (gltf) {
      var buff = gltf.scene;
      buff.traverse(function (object) {
        if (object.isMesh) object.castShadow = true;
        object.material = pMaterial;
      });
      buff.scale.set(0.5, 0.5, 0.5);
      buff.userData.name = 0;
      buff.position.y = -5;
      buff.material = pMaterial;
      particulasBuff.push(buff);
      scene.add(buff);
    });
    new GLTFLoader().load("models/arma/espada.glb", function (gltf) {
      var buff = gltf.scene;
      buff.traverse(function (object) {
        if (object.isMesh) object.castShadow = true;
        object.material = pMaterial;
      });
      buff.scale.set(0.5, 0.5, 0.5);
      buff.userData.name = 1;
      buff.position.y = -5;
      buff.material = pMaterial;
      particulasBuff.push(buff);
      scene.add(buff);
    });
  }
  function animarBuffer() {
    if (bufferActivado === true) {
      var orbita = 1.8;
      if (jugador?.position != undefined) {
        for (var i = 0; i < particulasBuff.length; i++) {
          var date = Date.now() * 0.006;
          if (particulasBuff[i].userData.name == 0) {
            var inversa = -1;
          } else {
            var inversa = 1;
          }
          particulasBuff[i].position.set(
            jugador.position.x + inversa * (Math.cos(date) * orbita),
            0.8,
            jugador.position.z + inversa * (Math.sin(date) * orbita)
          );
        }
      }
    } else {
      for (var i = 0; i < particulasBuff.length; i++) {
        particulasBuff[i].position.y = -5;
      }
    }
  }
  function activarBuffer() {
    if (coolDownFlag == 0) {
      var audio = new Audio("audio/power.mp3");
      audio.play();
      bufferActivado = !bufferActivado;
    }
    if (bufferActivado === true) {
      duracionBuffer();
    }
  }
  function duracionBuffer() {
    if (bufferActivado === true) {
      if (gameTime % 2 == 0) {
        segs += 0.05;
      }
    } else {
      segs = 0;
    }
    var segs2 = Math.floor(segs);

    if (bufferActivado === true && segs >= 30) {
      bufferActivado = false;
      segs = 0;
      coolDownFlag = 1;
      coolDown();
    }
  }
  function coolDown() {
    if (coolDownFlag == 1) {
      if (gameTime % 2 == 0) {
        segsCoolDown += 0.05;
      }
      var segs2 = Math.floor(segsCoolDown);
      mostrarTimerCoolDown(segs2);
      if (segs2 >= 10) {
        segsCoolDown = 0;
        coolDownFlag = 0;
        var bufferId = document.getElementById("buffer");
        bufferId.setAttribute("class", "fa-solid fa-sun");
      }
    }
  }
  function mostrarTimerCoolDown(segundos) {
    var bufferId = document.getElementById("buffer");
    if (segundos == 9) {
      bufferId.setAttribute("class", "fa-solid fa-1");
    }
    if (segundos == 8) {
      bufferId.setAttribute("class", "fa-solid fa-2");
    }
    if (segundos == 7) {
      bufferId.setAttribute("class", "fa-solid fa-3");
    }
    if (segundos == 6) {
      bufferId.setAttribute("class", "fa-solid fa-4");
    }
    if (segundos == 5) {
      bufferId.setAttribute("class", "fa-solid fa-5");
    }
    if (segundos == 4) {
      bufferId.setAttribute("class", "fa-solid fa-6");
    }
    if (segundos == 3) {
      bufferId.setAttribute("class", "fa-solid fa-7");
    }
    if (segundos == 2) {
      bufferId.setAttribute("class", "fa-solid fa-8");
    }
    if (segundos == 1) {
      bufferId.setAttribute("class", "fa-solid fa-9");
    }
  }
  function apagarLuces() {
    var selectLuzGeneral = scene.getObjectByName("luzGeneral");
    selectLuzGeneral.color.setHex(0x000000);
    selectLuzGeneral.intensity = 5;

    for (let i = 0; i < arrayLuces.length; i++) {
      arrayLuces[i].color.setHex(0x000000);
      arrayLuces[i].intensity = 5;
    }
    document.getElementById("morirCartel").style.left =
      window.innerWidth / 2 - 300 + "px";
    document.getElementById("morirCartel").style.display = "block";
  }

  function crearObjetosRandom(spawnArea, posicionX, posicionZ) {
    var cantidadObjetosRandom = Math.floor(Math.random() * (3 - 0)) + 0;
    for (let j = 0; j < cantidadObjetosRandom; j++) {
      var randomModelos = Math.floor(Math.random() * (10 - 1)) + 1;
      var geo = new THREE.BoxGeometry(2, 2, 2);
      // crear un cofre
      new GLTFLoader().load(
        "models/varios/" + randomModelos + ".glb",
        function (gltf) {
          var random = Math.floor(Math.random() * (800 - 0)) + 0 + j;
          const objetoExtra = gltf.scene;
          objetoExtra.traverse(function (object) {
            if (object.isMesh) object.castShadow = true;

            object.userData.draggable = true;
            object.name = "objetoExtra" + random;
            object.userData = {
              draggable: false,
              name: "objetoExtra" + random,
              tipo: "objetoExtra",
            };
          });
          var random = Math.floor(Math.random() * (250 - 0)) + 0;
          objetoExtra.rotation.y = random;
          objetoExtra.geometry = geo;
          if (randomModelos == 1 || randomModelos == 2) {
            objetoExtra.scale.set(0.8, 0.8, 0.8);
          } else {
            objetoExtra.scale.set(1.2, 1.2, 1.2);
          }
          objetoExtra.castShadow = true;
          objetoExtra.receiveShadow = true;
          objetoExtra.position.x =
            Math.floor(Math.random() * (spawnArea - 5 - -(spawnArea - 5))) +
            -(spawnArea - 5);
          objetoExtra.position.y = 0;
          objetoExtra.position.z =
            Math.floor(Math.random() * (spawnArea - 5 - -(spawnArea - 5))) +
            -(spawnArea - 5);

          objetoExtra.position.x += posicionX;
          objetoExtra.position.z += posicionZ;
          scene.add(objetoExtra);
          arraySolidos.push(objetoExtra);
          camera.updateProjectionMatrix();
        }
      );
    }
  }
  function chequearChoqueParedes() {
    for (let i = 0; i < arrayParedes.length; i++) {
      if (jugador?.position != undefined) {
        var resultado = checkearSiSeTocaJugador(jugador, arrayParedes[i]);
        if (resultado != "" && arrayParedes[i].userData.name == "Pared2") {
          jugador.position.x += -0.5;
        }
        if (resultado != "" && arrayParedes[i].userData.name == "Pared3") {
          jugador.position.x += 0.5;
        }
        if (resultado != "" && arrayParedes[i].userData.name == "Pared4") {
          jugador.position.z += 0.5;
        }
        if (resultado != "" && arrayParedes[i].userData.name == "Pared") {
          jugador.position.z += -0.5;
        }
      }
    }
  }
  function mostrarVidaEnemigo(enemigoVidaRestante) {
    document.getElementById("infoEnemigo").style.display = "block";
    document.getElementById("infoEnemigo").style.left =
      window.innerWidth / 2 - 130 + "px";
    document.getElementById("infoEnemigoBarra").value = enemigoVidaRestante;

    setTimeout(function () {
      document.getElementById("infoEnemigo").style.display = "none";
    }, 2000);
  }
  function acumularExperiencia(accion) {
    if (accion == "matar") {
      var extra = 10;
    } else {
      var extra = 0;
    }
    if (jugadorStats.nivel != 0) {
      jugadorStats.experiencia += (10 + extra) / jugadorStats.nivel;
    } else {
      jugadorStats.experiencia += 10 + extra;
    }

    if (jugadorStats.experiencia == 100) {
      var audio = new Audio("audio/guerrero/levelup.mp3");
      audio.play();
      jugadorStats.experiencia = 0;
      jugadorStats.nivel += 1;
      jugadorStats.fuerza += jugadorStats.nivel;
      jugadorStats.defensa += jugadorStats.nivel;
      mostrarLevelUp();
    }
    actualizarStatsJugador();
  }

  function mostrarLevelUp() {
    document.getElementById("levelup").style.display = "block";
    document.getElementById("levelup").style.left =
      window.innerWidth / 2 - 175 + "px";
    setTimeout(function () {
      document.getElementById("levelup").style.display = "none";
    }, 3000);
  }

  function crearMercado(spawnArea, posicionX, posicionZ) {
    var posibilidadDeCrearMercado = Math.floor(Math.random() * (10 - 0)) + 0;
    if (posibilidadDeCrearMercado == 4) {
      var randomCantidadArticulos = Math.floor(Math.random() * (15 - 5)) + 5;
      crearArticulosVenta(randomCantidadArticulos);
      var geo = new THREE.BoxGeometry(3, 3, 3);
      // crear un Mercado
      var nombreMercado =
        "mercado" +
        (Math.floor(Math.random() * (999999 - 0)) + 0) *
          (Math.floor(Math.random() * (10 - 1)) + 1);
      new GLTFLoader().load("models/mercado.glb", function (gltf) {
        var random = Math.floor(Math.random() * (800 - 0));
        const Mercado = gltf.scene;
        Mercado.traverse(function (object) {
          if (object.isMesh) object.castShadow = true;

          object.userData.draggable = true;
          object.name = nombreMercado;
          object.userData = {
            draggable: false,
            name: "Mercado",
            tipo: "Mercado",
            estado: "abierto",
          };
        });
        var random = Math.floor(Math.random() * (250 - 0)) + 0;
        Mercado.rotation.y = random;
        Mercado.geometry = geo;
        Mercado.scale.set(0.31, 0.31, 0.31);
        Mercado.castShadow = true;
        Mercado.receiveShadow = true;
        Mercado.position.x =
          Math.floor(Math.random() * (spawnArea - 5 - -(spawnArea - 5))) +
          -(spawnArea - 5);
        Mercado.position.y = 2;
        Mercado.position.z =
          Math.floor(Math.random() * (spawnArea - 5 - -(spawnArea - 5))) +
          -(spawnArea - 5);

        Mercado.position.x += posicionX;
        Mercado.position.z += posicionZ;
        scene.add(Mercado);
        arraySolidos.push(Mercado);
        camera.updateProjectionMatrix();
      });
    }
  }

  function abrirMercado() {
    // var contenedor = document.getElementById("contenedorMercado");
    // contenedor.innerHTML = ""
    rellenarMercado();
    document.getElementById("dineroMercado").innerHTML =
      "üí∞ " + jugadorStats.monedas;
    document.getElementById("mercado").style.display = "block";
  }

  function cerrarMercado() {
    // inventarioMercado = []
    document.getElementById("mercado").style.display = "none";
  }

  function rellenarMercado() {
    document.getElementById("dineroMercado").innerHTML =
      "üí∞ " + jugadorStats.monedas;
    var contenedor = document.getElementById("contenedorMercado");
    contenedor.innerHTML = "";
    for (let index = 0; index < inventarioMercado.length; index++) {
      var div = document.createElement("div");
      div.setAttribute("class", "dropdown");
      div.setAttribute("id", "dropdownidMercado");
      contenedor.appendChild(div);
      var equipoMercado = document.getElementById("dropdownidMercado");
      var boton = document.createElement("button");
      boton.setAttribute(
        "class",
        "dropbtn casillero animate__animated animate__fadeIn"
      );
      boton.setAttribute("id", "botonMercado" + index);
      boton.style.backgroundImage =
        "url(" + JSON.stringify(inventarioMercado[index].userData.imagen) + ")";
      boton.style.backgroundSize = "contain";
      boton.style.backgroundRepeat = "no-repeat";
      boton.style.backgroundPosition = "center";
      equipoMercado.appendChild(boton);
      var div = document.createElement("div");
      div.setAttribute("class", "dropdown-content");
      div.setAttribute("id", "dropdown-contentIdMercado" + index);
      equipoMercado.appendChild(div);
      var desplegable2 = document.getElementById(
        "dropdown-contentIdMercado" + index
      );
      let eventoBoton2 = document.getElementById("botonMercado" + index);
      eventoBoton2.addEventListener(
        "click",
        function (event) {
          var desplegableItem = document.getElementById(
            "dropdown-contentIdMercado" + index
          );
          desplegableItem.style.display = "block";
          var boton = document.getElementById("botonMercado" + index);
          boton.style.backgroundColor = "#8bd48d94";
          var mouseX = event.clientX / window.innerWidth + 50;
          var mouseY = -(event.clientY / window.innerHeight) * 2 + 50;
          desplegableItem.style.top = mouseY + "px";
          desplegableItem.style.left = mouseX + "px";
        },
        false
      );
      eventoBoton2.addEventListener(
        "mouseleave",
        function (event) {
          setTimeout(function () {
            var desplegable2 = document.getElementById(
              "dropdown-contentIdMercado" + index
            );
            desplegable2.style.display = "none";
            var boton = document.getElementById("botonMercado" + index);
            boton.style.backgroundColor = "";
          }, 3000);
        },
        false
      );
      var link2 = document.createElement("a");
      link2.innerHTML = "üí∞ " + inventarioMercado[index].userData.precio;
      desplegable2.appendChild(link2);
      var link2 = document.createElement("a");
      link2.innerHTML = "Comprar";
      link2.setAttribute("class", "accionItemLeyenda");
      link2.setAttribute("onclick", "comprar(" + index + ")");
      desplegable2.appendChild(link2);
      var info = document.createElement("div");
      info.setAttribute("id", "infoMercado" + index);
      info.setAttribute("class", "infoArma");
      desplegable2.appendChild(info);
      var infoId2 = document.getElementById("infoMercado" + index);
      var infoItem2 = document.createElement("p");
      infoItem2.innerHTML =
        inventarioMercado[index].userData.nombre.toUpperCase();
      infoId2.appendChild(infoItem2);
      if (
        inventarioMercado[index].userData.categoria != "pocion" ||
        inventarioMercado[index].userData.nombre != "Pocion"
      ) {
        var infoItem2 = document.createElement("p");
        infoItem2.innerHTML =
          "‚öîÔ∏è ATK: " + inventarioMercado[index].userData.ataque;
        infoId2.appendChild(infoItem2);
        var infoItem2 = document.createElement("p");
        infoItem2.innerHTML =
          "üõ°Ô∏è DEF: " + inventarioMercado[index].userData.defensa;
        infoId2.appendChild(infoItem2);
        var infoItem2 = document.createElement("p");
        infoItem2.innerHTML =
          "‚öñÔ∏è WT: " + inventarioMercado[index].userData.peso;
        infoId2.appendChild(infoItem2);
      } else {
        var infoItem2 = document.createElement("p");
        infoItem2.innerHTML =
          "üç∑ QTY: " + inventarioMercado[index].userData.cantidad;
        infoId2.appendChild(infoItem2);
      }
    }
  }
  function crearArticulosVenta(cantidad) {
    for (let index = 0; index < cantidad; index++) {
      var randomItem = Math.floor(Math.random() * (8 - 1)) + 1;
      var tipoDeItem = Math.floor(Math.random() * (6 - 1)) + 1;
      if (tipoDeItem == 1) {
        var resultadoItem = devolverItemParaLootArmadura(randomItem);
      }
      if (tipoDeItem == 2) {
        var resultadoItem = devolverItemParaLootArma(randomItem);
      }
      if (tipoDeItem == 3) {
        var resultadoItem = devolverItemParaLootAnillo(randomItem);
      }
      if (tipoDeItem == 4) {
        var resultadoItem = devolverItemParaLootCollar(randomItem);
      }
      if (tipoDeItem == 5) {
        var resultadoItem = devolverItemParaLootPocion(randomItem);
      }
      if (tipoDeItem == 6) {
        var resultadoItem = devolverItemParaLootMoneda(randomItem);
      }
      new GLTFLoader().load(resultadoItem + ".glb", function (gltf) {
        const loot = gltf.scene;
        loot.traverse(function (object) {
          if (object.isMesh) object.castShadow = true;
        });
        var geo = new THREE.BoxGeometry(1, 1, 1);
        loot.geometry = geo;
        loot.scale.set(0.8, 0.8, 0.8);
        var random = Math.floor(Math.random() * (250 - 0)) + 0;
        var tipo = tipoLootSegunNombreObjeto3D(loot.children[0].name);
        if (tipo != "moneda") {
          loot.rotation.x = -Math.PI / 2;
          loot.rotation.z = random;
        }
        if (tipo == "anillo") {
          loot.scale.set(0.4, 0.4, 0.4);
        }
        if (tipo == "pocion") {
          loot.scale.set(0.4, 0.4, 0.4);
        }
        if (tipo == "moneda") {
          loot.userData = {
            nombre: "Monedas",
            cantidad: Math.floor(Math.random() * (250 - 10)) + 10,
            peso: 0,
            tipo: "recurso",
            categoria: "moneda",
            imagen: "img/item/moneda.png",
            precio:
              (Math.floor(Math.random() * (80 - 10)) + 10) * jugadorStats.nivel,
          };
        }
        if (tipo == "pocion") {
          loot.userData = {
            nombre: "Pocion",
            cantidad: Math.floor(Math.random() * (250 - 10)) + 10,
            tipo: "recurso",
            peso: 3,
            categoria: "pocion",
            imagen: "img/item/pocion.png",
            precio:
              (Math.floor(Math.random() * (80 - 10)) + 10) * jugadorStats.nivel,
          };
        }
        if (tipo == "armadura") {
          var nombreRandom =
            lootArrayArmadura[
              Math.floor(Math.random() * (lootArrayArmadura.length - 0)) + 0
            ];
          loot.userData = {
            nombre: nombreRandom,
            ataque:
              (Math.floor(Math.random() * (25 - 1)) + 1) * jugadorStats.nivel,
            defensa:
              (Math.floor(Math.random() * (25 - 1)) + 1) * jugadorStats.nivel,
            peso: Math.floor(Math.random() * (100 - 1)) + 1,
            tipo: "recurso",
            categoria: "armadura",
            imagen: "img/item/armadura.png",
            glb: resultadoItem,
            precio:
              (Math.floor(Math.random() * (800 - 100)) + 100) *
              jugadorStats.nivel,
          };
        }
        if (tipo == "arma") {
          var nombreRandom =
            lootArrayArma[
              Math.floor(Math.random() * (lootArrayArma.length - 0)) + 0
            ];
          loot.userData = {
            nombre: nombreRandom,
            ataque:
              (Math.floor(Math.random() * (20 - 1)) + 1) * jugadorStats.nivel,
            defensa:
              (Math.floor(Math.random() * (20 - 1)) + 1) * jugadorStats.nivel,
            peso: Math.floor(Math.random() * (100 - 1)) + 1,
            tipo: "recurso",
            categoria: "arma",
            imagen: "img/item/arma.png",
            glb: resultadoItem,
            precio:
              (Math.floor(Math.random() * (800 - 100)) + 100) *
              jugadorStats.nivel,
          };
        }
        if (tipo == "collar") {
          var nombreRandom =
            lootArrayCollar[
              Math.floor(Math.random() * (lootArrayCollar.length - 0)) + 0
            ];
          loot.userData = {
            nombre: nombreRandom,
            ataque:
              (Math.floor(Math.random() * (12 - 1)) + 1) * jugadorStats.nivel,
            defensa:
              (Math.floor(Math.random() * (12 - 1)) + 1) * jugadorStats.nivel,
            peso: Math.floor(Math.random() * (5 - 1)) + 1,
            tipo: "recurso",
            categoria: "collar",
            imagen: "img/item/collar.png",
            glb: resultadoItem,
            precio:
              (Math.floor(Math.random() * (800 - 100)) + 100) *
              jugadorStats.nivel,
          };
        }
        if (tipo == "anillo") {
          var nombreRandom =
            lootArrayAnillo[
              Math.floor(Math.random() * (lootArrayAnillo.length - 0)) + 0
            ];
          loot.userData = {
            nombre: nombreRandom,
            ataque:
              (Math.floor(Math.random() * (8 - 1)) + 1) * jugadorStats.nivel,
            defensa:
              (Math.floor(Math.random() * (8 - 1)) + 1) * jugadorStats.nivel,
            peso: Math.floor(Math.random() * (3 - 1)) + 1,
            tipo: "recurso",
            categoria: "anillo",
            imagen: "img/item/anillo.png",
            glb: resultadoItem,
            precio:
              (Math.floor(Math.random() * (80 - 10)) + 10) * jugadorStats.nivel,
          };
        }
        loot.parent = {
          userData: loot.userData,
        };
        var nombreRandomParaBorrar =
          "articuloComprado" +
          (Math.floor(Math.random() * (999999 - 0)) + 0) *
            (Math.floor(Math.random() * (10 - 1)) + 1);
        loot.name = nombreRandomParaBorrar;
        inventarioMercado.push(loot);
      });
    }
    rellenarMercado();
  }
  function comprar(index) {
    if (
      jugadorStats.monedas >= inventarioMercado[index].userData.precio &&
      jugadorStats.peso + inventarioMercado[index].userData.peso <= 200
    ) {
      var audio = new Audio("audio/comprar.mp3");
      audio.play();
      jugadorStats.monedas -= inventarioMercado[index].userData.precio;
      inventario.push(inventarioMercado[index]);
      inventarioMercado.splice(index, 1);
      actualizarStatsJugador();
      cargarInventario();
      rellenarMercado();
    } else {
      document.getElementById("noPuedesComprar").style.display = "block";
      setTimeout(function () {
        document.getElementById("noPuedesComprar").style.display = "none";
      }, 2000);
    }
  }

  function crearPuerta(ubicacion, posX, posZ) {
    // crear una puerta

    var geo = new THREE.BoxGeometry(2, 2, 5);
    new GLTFLoader().load("models/puertagrande.glb", function (gltf) {
      var random =
        (Math.floor(Math.random() * (999999 - 0)) + 0) *
        (Math.floor(Math.random() * (10 - 1)) + 1);
      const puerta = gltf.scene;
      puerta.traverse(function (object) {
        if (object.isMesh) object.castShadow = true;
        object.userData.draggable = true;
        object.name = "puerta" + random;
        object.userData = {
          ubicacion: ubicacion,
          creoHabitacion: false,
          draggable: false,
          name: "puerta" + random,
          tipo: "puerta",
        };
      });
      if(ubicacion == "derecha"){
        puerta.rotation.y = Math.PI / 2;
      }
      puerta.geometry = geo;
      puerta.castShadow = true;
      puerta.receiveShadow = true;
      puerta.position.x = posX;
      puerta.position.y = 0;
      puerta.position.z = posZ;
      puerta.scale.set(1, 1, 10);
      scene.add(puerta);
      arrayPuertas.push(puerta);
    });
  }

  function chequearEntrarPuerta() {
    if (jugador?.position != undefined) {
      for (let index = 0; index < arrayPuertas.length; index++) {
        var resultado = checkearSiSeTocaJugador(jugador, arrayPuertas[index]);
        if (resultado != false) {
          var puertaUbicacion = arrayPuertas[index].userData.ubicacion;




          //PUERTA ATRAS !!
          if (puertaUbicacion == "atras" && arrayPuertas[index].userData.creoHabitacion === false ) {
            arrayPuertas[index].userData.creoHabitacion = true;
            var tama√±oHabitacion = 50;
            var difEncaje = 0.5;
            var posX = arrayPuertas[index].position.x;
            var posZ =
              arrayPuertas[index].position.z +
              (tama√±oHabitacion / 2 + difEncaje);
            jugador.position.z += 5;
            skybox.position.x = jugador.position.x;
            skybox.position.z = jugador.position.z;
            luzGeneral.position.set(jugador.position.x, 10, jugador.position.z);
            crearHabitacion(tama√±oHabitacion, posX, posZ);
          }
          if ( puertaUbicacion == "atras" && arrayPuertas[index].userData.creoHabitacion === true ) {
            if (arrayPuertas[index].position.z > jugador.position.z) {
              jugador.position.z += 5;
              skybox.position.x = jugador.position.x;
              skybox.position.z = jugador.position.z;
              luzGeneral.position.set(
                jugador.position.x,
                10,
                jugador.position.z
              );
            } else {
              jugador.position.z -= 5;
              skybox.position.x = jugador.position.x;
              skybox.position.z = jugador.position.z;
              luzGeneral.position.set(
                jugador.position.x,
                10,
                jugador.position.z
              );
            }
          }






        //PUERTA DERECHA !!
        if (puertaUbicacion == "derecha" && arrayPuertas[index].userData.creoHabitacion === false ) {
            arrayPuertas[index].userData.creoHabitacion = true;
            var tama√±oHabitacion = 50;
            var difEncaje = 0.5;
            var posZ = arrayPuertas[index].position.z;
            var posX = arrayPuertas[index].position.x + (tama√±oHabitacion / 2 + difEncaje);
            jugador.position.x += 5;
            skybox.position.x = jugador.position.x;
            skybox.position.z = jugador.position.z;
            luzGeneral.position.set(jugador.position.x, 10, jugador.position.z);
            crearHabitacion(tama√±oHabitacion, posX, posZ);
          }
          if ( puertaUbicacion == "derecha" && arrayPuertas[index].userData.creoHabitacion === true ) {
            if (arrayPuertas[index].position.z > jugador.position.z) {
              jugador.position.x += 5;
              skybox.position.x = jugador.position.x;
              skybox.position.z = jugador.position.z;
              luzGeneral.position.set(
                jugador.position.x,
                10,
                jugador.position.z
              );
            } else {
              jugador.position.x -= 5;
              skybox.position.x = jugador.position.x;
              skybox.position.z = jugador.position.z;
              luzGeneral.position.set(
                jugador.position.x,
                10,
                jugador.position.z
              );
            }
          }








        }
      }
    }
  }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
